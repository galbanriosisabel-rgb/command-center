<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Medical Department Command Center â€” Prototype</title>
<style>
  :root{
    --bg:#0b0d10; --panel:#11151b; --panel2:#0f1318; --card:#141a22;
    --text:#e7e9ee; --muted:#aab0bd; --border:#263244;
    --red:#d10f2f; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --link:#7dd3fc;
    --shadow:0 12px 30px rgba(0,0,0,.35);
    --r:18px; --r2:14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:var(--sans); color:var(--text);
    background: radial-gradient(1200px 600px at 10% 0%, rgba(209,15,47,.18), transparent 55%),
                radial-gradient(900px 600px at 95% 15%, rgba(125,211,252,.12), transparent 60%),
                linear-gradient(180deg, #07080a, #0b0d10 20%, #0b0d10);
    min-height:100vh;
  }
  a{color:var(--link); text-decoration:none}
  .topbar{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(10px);
    background: rgba(9,11,14,.72);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .topbar-inner{
    max-width:1200px; margin:0 auto; padding:14px 16px;
    display:flex; align-items:center; gap:12px;
  }
  .brand{
    display:flex; align-items:center; gap:10px; min-width:260px;
  }
  .dot{width:12px; height:12px; border-radius:50%; background:var(--red); box-shadow:0 0 0 6px rgba(209,15,47,.15)}
  .title{font-weight:800; letter-spacing:.2px}
  .subtitle{color:var(--muted); font-size:13px}
  .tabs{display:flex; gap:8px; flex:1}
  .tab{
    padding:9px 12px; border-radius:999px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    color:var(--text);
    cursor:pointer; user-select:none;
  }
  .tab.active{border-color: rgba(125,211,252,.25); box-shadow: inset 0 0 0 1px rgba(125,211,252,.18)}
  .actionsBar{display:flex; gap:10px; align-items:center}
  .btn{
    display:inline-flex; align-items:center; gap:10px;
    padding:10px 14px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    color:var(--text);
    cursor:pointer;
  }
  .btn.primary{
    border-color: rgba(209,15,47,.45);
    background: linear-gradient(180deg, rgba(209,15,47,.25), rgba(209,15,47,.12));
  }
  .btn:hover{border-color: rgba(255,255,255,.22)}
  .btn svg{width:18px; height:18px; fill:currentColor; opacity:.9}
  .container{max-width:1200px; margin:0 auto; padding:18px 16px 90px}
  .pageTitle{font-size:28px; font-weight:900; margin:14px 0 4px}
  .pageHint{color:var(--muted); margin:0 0 16px}
  .grid2{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px}
  .kpis{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin:10px 0 14px}
  .kpi{
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);
    border-radius: var(--r);
    padding:14px 14px 12px;
    box-shadow: var(--shadow);
  }
  .kpi .label{display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:700}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.02); color:var(--text); cursor:pointer;}
  .pill .miniDot{width:10px; height:10px; border-radius:50%;}
  .bigNum{font-size:34px; font-weight:900; margin-top:8px}
  .card{
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);
    border-radius: var(--r);
    padding:14px;
    box-shadow: var(--shadow);
  }
  .card h3{margin:0 0 10px; font-size:16px; letter-spacing:.2px}
  .tools{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px}
  .input, select, textarea{
    width:100%;
    padding:10px 12px;
    border-radius: 14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    color: var(--text);
    outline:none;
  }
  textarea{min-height:120px; resize:vertical}
  .tools .input, .tools select{width:auto; min-width:240px}
  .tools select{min-width:190px}
  .mini{color:var(--muted); font-size:12px}
  table{width:100%; border-collapse:separate; border-spacing:0}
  th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top}
  th{color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.12em; text-align:left}
  td{font-size:14px}
  .nowrap{white-space:nowrap}
  .cellSelect{
    width:100%;
    padding:8px 10px;
    border-radius: 12px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.18);
    color:var(--text);
  }
  .rowActions{white-space:nowrap}
  .iconBtn{
    display:inline-flex; align-items:center; justify-content:center;
    width:34px; height:34px; border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
    color: var(--text);
    cursor:pointer;
    margin-right:6px;
  }
  .iconBtn svg{width:18px; height:18px; fill:currentColor; opacity:.92}
  .iconBtn.danger{border-color: rgba(239,68,68,.35); color: var(--bad)}
  .iconBtn:hover{border-color: rgba(255,255,255,.22)}
  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.02);
    font-size:12px; color:var(--muted);
  }
  .badge strong{color:var(--text)}
  /* Modal */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; z-index:50; align-items:center; justify-content:center; padding:20px}
  .modal{
    width:min(920px, 95vw);
    background: rgba(15,19,24,.92);
    border:1px solid rgba(255,255,255,.10);
    border-radius: 22px;
    box-shadow: 0 30px 90px rgba(0,0,0,.6);
    overflow:hidden;
  }
  .modalHead{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
  .modalHead h2{margin:0; font-size:18px}
  .modalBody{padding:14px 16px}
  .modalGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .modalFoot{display:flex; justify-content:space-between; gap:10px; padding:14px 16px; border-top:1px solid rgba(255,255,255,.08)}
  .toastWrap{position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:60}
  .toast{background:rgba(15,19,24,.92); border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:10px 12px; box-shadow: var(--shadow); width: min(420px, 92vw)}
  .toast .t{font-weight:800}
  .toast .m{color:var(--muted); font-size:13px; margin-top:4px}
  /* Assistant */
  .assistant{
    position:fixed; right:16px; bottom:16px;
    width:min(420px, 92vw);
    max-height: 70vh;
    background: rgba(15,19,24,.92);
    border:1px solid rgba(255,255,255,.12);
    border-radius: 22px;
    box-shadow: 0 30px 80px rgba(0,0,0,.55);
    overflow:hidden;
    display:none;
    z-index:70;
  }
  .assistantHead{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08)}
  .assistantHead .name{display:flex; align-items:center; gap:10px; font-weight:900}
  .assistantHead .pending{color:var(--muted); font-size:13px}
  .assistantBody{padding:12px 12px 0; overflow:auto; max-height: calc(70vh - 120px)}
  .bubble{border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); border-radius: 18px; padding:10px 12px; margin-bottom:10px}
  .bubble.me{border-color: rgba(125,211,252,.18)}
  .bubble .small{color:var(--muted); font-size:12px; margin-top:6px}
  .assistantFoot{padding:12px; border-top:1px solid rgba(255,255,255,.08); display:flex; gap:10px}
  .assistantFoot input{flex:1}
  .ghostBtn{background:transparent; border:1px solid rgba(255,255,255,.10); color:var(--text); border-radius:999px; padding:9px 12px; cursor:pointer}
  .ghostBtn:hover{border-color: rgba(255,255,255,.22)}
  @media (max-width: 980px){
    .grid2{grid-template-columns: 1fr}
    .kpis{grid-template-columns: repeat(2, minmax(0,1fr))}
    .brand{min-width:auto}
    .tabs{display:none}
  }
</style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Command Center</div>
          <div class="subtitle">Medical Department â€¢ Prototype</div>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>

      <div class="actionsBar">
        <button class="btn" id="btnToggleAssistant" title="Toggle assistant">
          <svg viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7v4a3 3 0 0 0 3 3h1v3l3-3h3a3 3 0 0 0 3-3V9a7 7 0 0 0-7-7zm-2 9h4v2h-4v-2zm0-4h4v2h-4V7z"/></svg>
          Toggle Assistant
        </button>
        <button class="btn" id="btnDownload" title="Download CSV">
          <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2v12l4-4 1.4 1.4L12 18l-5.4-5.6L8 10l4 4V2h0z"/></svg>
          Download Excel
        </button>
        <button class="btn primary" id="btnGenerate" title="Generate 4pm draft">
          <svg viewBox="0 0 24 24"><path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zm-2 16H7v-2h10v2zm0-4H7v-2h10v2zm-3-7H6V6h8v2z"/></svg>
          Generate 4pm Draft
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div id="page"></div>
  </div>

  <!-- Modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <h2 id="modalTitle">Modal</h2>
        <button class="ghostBtn" id="modalClose">âœ• Close</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot">
        <div class="mini" id="modalHint"></div>
        <div style="display:flex; gap:10px">
          <button class="ghostBtn" id="modalCancel">Cancel</button>
          <button class="btn primary" id="modalSave">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assistant -->
  <div class="assistant" id="assistant">
    <div class="assistantHead">
      <div class="name"><span class="dot" style="width:10px;height:10px;box-shadow:none"></span> Isabel's Assistant</div>
      <div class="pending"><span id="pendingCount">0</span> pending</div>
    </div>
    <div class="assistantBody" id="assistantBody"></div>
    <div class="assistantFoot">
      <input class="input" id="assistantInput" placeholder="Example: 'show needs reply' or 'update patient 107853 waitingOn=Clinic'"/>
      <button class="btn primary" id="assistantSend">Send</button>
    </div>
  </div>

  <div class="toastWrap" id="toasts"></div>

<script>
(() => {
  // -----------------------------
  // Icons
  // -----------------------------
  const ICON_EDIT = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.33H5v-.92l9.06-9.06.92.92L5.92 19.58zM20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.29a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
  const ICON_TRASH = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2z"/></svg>`;
  const ICON_EMAIL = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 4-8 5L4 8V6l8 5 8-5v2z"/></svg>`;
  const ICON_SAVE = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zM12 19a3 3 0 1 1 0-6 3 3 0 0 1 0 6zM6 8V5h10v3H6z"/></svg>`;

  // -----------------------------
  // Options (Dropdowns)
  // -----------------------------
  const OPTIONS = {
    patientTypes: ["MRI","PT","Chiro/PT","Chiro","Ortho","Neuro","Pain Mgmt","Other"],
    patientStatus: ["New","Sent to clinic","Stuck","Needs reply","Done"],
    waitingOn: ["Clinic","You","Attorney","Client","Records","Scheduling","Transportation","Other"],
    taskType: ["Follow-up clinic","Reply email","Update Clio","Send referral","Other"],
    taskPriority: ["High","Medium","Low"],
    taskProgress: ["Open","Done","Updated"]
  };

  // -----------------------------
  // State
  // -----------------------------
  const STORAGE_KEY = "command_center_v5";
  const defaultState = () => ({
    ui: { tab:"Home", patientSearch:"", patientStatus:"all", patientWaiting:"all", taskSearch:"", reportEditingId:null },
    patients: [],
    tasks: [],
    reports: [],
    assistant: { open:false, chat:[], lastMatter:null, pending:0 }
  });

  let state = loadState();

  // -----------------------------
  // Helpers
  // -----------------------------
  const $ = (q, root=document) => root.querySelector(q);
  const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
  const norm = (s)=> (s??"").toString().trim();
  const lower = (s)=> norm(s).toLowerCase();
  const escapeHtml = (s)=> norm(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  const buildOptions = (list, selected) => list.map(v => `<option value="${escapeHtml(v)}" ${v===selected?"selected":""}>${escapeHtml(v)}</option>`).join("");
  const nowStamp = () => new Date().toLocaleString();
  const cryptoId = () => (crypto?.randomUUID?.() || ("id_"+Math.random().toString(16).slice(2)+Date.now()));
  function toast(title, msg){
    const wrap = $("#toasts");
    const el = document.createElement("div");
    el.className="toast";
    el.innerHTML = `<div class="t">${escapeHtml(title)}</div><div class="m">${escapeHtml(msg)}</div>`;
    wrap.appendChild(el);
    setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, 3400);
    setTimeout(()=> el.remove(), 4200);
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.warn(e); }
    $("#pendingCount").textContent = String(state.assistant.pending||0);
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      // merge for forward compatibility
      return {...defaultState(), ...parsed, ui:{...defaultState().ui, ...(parsed.ui||{})}, assistant:{...defaultState().assistant, ...(parsed.assistant||{})}};
    }catch(e){
      return defaultState();
    }
  }

  // -----------------------------
  // Modal
  // -----------------------------
  const backdrop = $("#backdrop");
  const modalTitle = $("#modalTitle");
  const modalBody = $("#modalBody");
  const modalHint = $("#modalHint");
  let modalOnSave = null;

  function openModal(title, html, hint, onSave){
    modalTitle.textContent = title;
    modalBody.innerHTML = html;
    modalHint.textContent = hint || "";
    modalOnSave = onSave || null;
    backdrop.style.display="flex";
  }
  function closeModal(){
    backdrop.style.display="none";
    modalBody.innerHTML = "";
    modalOnSave = null;
  }
  $("#modalClose").addEventListener("click", closeModal);
  $("#modalCancel").addEventListener("click", closeModal);
  $("#modalSave").addEventListener("click", () => { if(modalOnSave) modalOnSave(); });

  // -----------------------------
  // Rendering
  // -----------------------------
  const TABS = ["Home","Patients","Tasks","Reports"];

  function renderTabs(){
    const el = $("#tabs");
    el.innerHTML = TABS.map(t => `<div class="tab ${state.ui.tab===t?"active":""}" data-tab="${t}">${t}</div>`).join("");
  }

  function render(){
    renderTabs();
    renderAssistant();
    const page = $("#page");
    if(state.ui.tab==="Home") page.innerHTML = renderHome();
    if(state.ui.tab==="Patients") page.innerHTML = renderPatients();
    if(state.ui.tab==="Tasks") page.innerHTML = renderTasks();
    if(state.ui.tab==="Reports") page.innerHTML = renderReports();
    wirePage();
    saveState();
  }

  function kpi(label, value, dotColor, pillText, pillAction){
    return `
      <div class="kpi">
        <div class="label">
          <span class="miniDot" style="background:${dotColor}"></span>
          <span>${escapeHtml(label)}</span>
        </div>
        <div class="bigNum">${value}</div>
        <div style="margin-top:10px">
          <span class="pill" data-action="${pillAction||""}">
            <span class="miniDot" style="background:${dotColor}"></span>
            ${escapeHtml(pillText||"filter")}
          </span>
        </div>
      </div>
    `;
  }

  function computeHome(){
    const today = new Date().toISOString().slice(0,10);
    const overdue = state.tasks.filter(t => lower(t.progress)==="open" && t.dueDate && t.dueDate < today).length;
    const needsReply = state.patients.filter(p => lower(p.status)==="needs reply").length
                    + state.tasks.filter(t => lower(t.taskType).includes("reply") && lower(t.progress)==="open").length;
    const newToday = state.patients.filter(p => (p.createdAt||"").slice(0,10)===today).length;
    const waitingClinic = state.patients.filter(p => lower(p.waitingOn)==="clinic" && lower(p.status)!=="done").length;
    return { overdue, needsReply, newToday, waitingClinic };
  }

  function renderHome(){
    const { overdue, needsReply, newToday, waitingClinic } = computeHome();
    const priorityPatients = state.patients.slice(0, 12);
    const inbox = state.tasks.filter(t => lower(t.progress)==="open").slice(0, 12);

    return `
      <div class="pageTitle">Home</div>
      <p class="pageHint">Quick view of what matters today</p>

      <div class="kpis">
        ${kpi("Overdue today", overdue, "var(--bad)", "follow-up overdue", "home_overdue")}
        ${kpi("Needs reply", needsReply, "var(--warn)", "reply today", "home_needs_reply")}
        ${kpi("New today", newToday, "var(--ok)", "created today", "home_new_today")}
        ${kpi("Waiting on clinic", waitingClinic, "var(--muted)", "no response", "home_waiting_clinic")}
      </div>

      <div class="grid2">
        <div class="card">
          <h3>ðŸ“Œ Priority (Today)</h3>
          <div class="tools">
            <span class="badge">Tip: click a KPI tag above to filter lists.</span>
          </div>
          ${tablePatients(priorityPatients, {compact:true})}
        </div>

        <div class="card">
          <h3>ðŸ“¨ Action Inbox (Email â†’ Tasks)</h3>
          ${tableTasks(inbox, {compact:true})}
        </div>
      </div>
    `;
  }

  function tablePatients(list, {compact=false}={}){
    if(list.length===0){
      return `<div class="mini">No patients yet. Use <strong>Quick Log</strong> to add one.</div>`;
    }
    const rows = list.map(p => {
      const matter = escapeHtml(p.matter);
      const statusSel = `<select class="cellSelect" data-action="p_update" data-field="status" data-matter="${matter}">
        ${buildOptions(OPTIONS.patientStatus, p.status||"New")}
      </select>`;
      const waitSel = `<select class="cellSelect" data-action="p_update" data-field="waitingOn" data-matter="${matter}">
        ${buildOptions(OPTIONS.waitingOn, p.waitingOn||"Clinic")}
      </select>`;
      const typeSel = `<select class="cellSelect" data-action="p_update" data-field="type" data-matter="${matter}">
        ${buildOptions(OPTIONS.patientTypes, p.type||"MRI")}
      </select>`;

      return `
        <tr>
          <td class="nowrap"><a class="link" data-action="open_patient" data-matter="${matter}">${matter}</a></td>
          <td>${escapeHtml(p.patient||"")}</td>
          <td class="nowrap">${escapeHtml(p.state||"")}</td>
          ${compact ? "" : `<td>${typeSel}</td>`}
          <td>${escapeHtml(p.provider||"")}</td>
          ${compact ? "" : `<td class="nowrap">${escapeHtml(p.requestedDate||"")}</td>`}
          ${compact ? "" : `<td>${escapeHtml(p.sender||"")}</td>`}
          <td>${statusSel}</td>
          <td>${waitSel}</td>
          ${compact ? "" : `<td style="max-width:320px">${escapeHtml(p.notes||"")}</td>`}
          <td class="rowActions">
            <button class="iconBtn" data-action="edit_patient" data-matter="${matter}" title="Edit">${ICON_EDIT}</button>
            <button class="iconBtn danger" data-action="del_patient" data-matter="${matter}" title="Delete">${ICON_TRASH}</button>
          </td>
        </tr>
      `;
    }).join("");

    const head = `
      <tr>
        <th>Matter</th><th>Patient</th><th>State</th>
        ${compact ? "" : "<th>Type</th>"}
        <th>Provider</th>
        ${compact ? "" : "<th>Requested</th><th>Sender</th>"}
        <th>Status</th><th>Waiting On</th>
        ${compact ? "" : "<th>Notes</th>"}
        <th></th>
      </tr>
    `;

    return `
      <div style="overflow:auto">
        <table>
          <thead>${head}</thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function renderPatients(){
    return `
      <div class="pageTitle">Patients</div>
      <p class="pageHint">Your operational list</p>

      <div class="card">
        <div class="tools">
          <input class="input" id="patientSearch" placeholder="Search by patient, matter, state, provider, notes" value="${escapeHtml(state.ui.patientSearch||"")}"/>
          <select id="patientStatusFilter">
            ${["all", ...OPTIONS.patientStatus].map(v=>`<option value="${v}" ${state.ui.patientStatus===v?"selected":""}>Status (${v})</option>`).join("")}
          </select>
          <select id="patientWaitingFilter">
            ${["all", ...OPTIONS.waitingOn].map(v=>`<option value="${v}" ${state.ui.patientWaiting===v?"selected":""}>Waiting (${v})</option>`).join("")}
          </select>
          <button class="btn" id="btnQuickPatient">+ Quick Log</button>
          <button class="btn" id="patientClear">Clear</button>
        </div>

        ${tablePatients(filteredPatients(), {compact:false})}
        <div class="mini" style="margin-top:8px">Quick Log adds a new patient row (auto-saved on your device).</div>
      </div>
    `;
  }

  function filteredPatients(){
    const q = lower(state.ui.patientSearch);
    const status = state.ui.patientStatus;
    const waiting = state.ui.patientWaiting;

    return state.patients
      .filter(p => {
        const hay = lower([p.matter,p.patient,p.state,p.type,p.provider,p.requestedDate,p.sender,p.status,p.waitingOn,p.notes].join(" "));
        if(q && !hay.includes(q)) return false;
        if(status && status!=="all" && norm(p.status)!==status) return false;
        if(waiting && waiting!=="all" && norm(p.waitingOn)!==waiting) return false;
        return true;
      });
  }

  function tableTasks(list, {compact=false}={}){
    if(list.length===0){
      return `<div class="mini">No tasks yet. Use <strong>Quick Log</strong> to add one.</div>`;
    }
    const rows = list.map(t => {
      const id = escapeHtml(t.id);
      const matter = escapeHtml(t.matter||"");
      const typeSel = `<select class="cellSelect" data-action="t_update" data-field="taskType" data-id="${id}">
        ${buildOptions(OPTIONS.taskType, t.taskType||"Follow-up clinic")}
      </select>`;
      const prSel = `<select class="cellSelect" data-action="t_update" data-field="priority" data-id="${id}">
        ${buildOptions(OPTIONS.taskPriority, t.priority||"Medium")}
      </select>`;
      const progSel = `<select class="cellSelect" data-action="t_update" data-field="progress" data-id="${id}">
        ${buildOptions(OPTIONS.taskProgress, t.progress||"Open")}
      </select>`;

      return `
        <tr>
          <td class="nowrap"><a class="link" data-action="open_patient" data-matter="${matter}">${matter||"-"}</a></td>
          ${compact ? "" : `<td>${typeSel}</td>`}
          <td>${prSel}</td>
          <td>${progSel}</td>
          <td style="max-width:360px">${escapeHtml(t.description||"")}</td>
          <td class="rowActions">
            <button class="iconBtn" data-action="edit_task" data-id="${id}" title="Edit">${ICON_EDIT}</button>
            <button class="iconBtn danger" data-action="del_task" data-id="${id}" title="Delete">${ICON_TRASH}</button>
          </td>
        </tr>
      `;
    }).join("");

    const head = `
      <tr>
        <th>Matter</th>
        ${compact ? "" : "<th>Type</th>"}
        <th>Priority</th><th>Progress</th><th>Description</th><th></th>
      </tr>
    `;

    return `
      <div style="overflow:auto">
        <table>
          <thead>${head}</thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  function renderTasks(){
    return `
      <div class="pageTitle">Tasks</div>
      <p class="pageHint">Action list</p>

      <div class="card">
        <div class="tools">
          <input class="input" id="taskSearch" placeholder="Search by matter, type, description" value="${escapeHtml(state.ui.taskSearch||"")}"/>
          <button class="btn" id="btnQuickTask">+ Quick Log</button>
          <button class="btn" id="taskClear">Clear</button>
        </div>

        ${tableTasks(filteredTasks(), {compact:false})}
        <div class="mini" style="margin-top:8px">Tasks are auto-saved on your device.</div>
      </div>
    `;
  }

  function filteredTasks(){
    const q = lower(state.ui.taskSearch);
    return state.tasks.filter(t => {
      const hay = lower([t.matter,t.taskType,t.priority,t.progress,t.description].join(" "));
      return !q || hay.includes(q);
    });
  }

  function renderReports(){
    const current = state.ui.reportEditingId ? state.reports.find(r => r.id===state.ui.reportEditingId) : null;
    const label = state.ui.reportEditingId ? `Editing saved report â€¢ ${current ? current.when : ""}` : "4pm report";

    return `
      <div class="pageTitle">Reports</div>
      <p class="pageHint">${escapeHtml(label)}</p>

      <div class="card">
        <h3>ðŸ“Š 4pm report</h3>
        <div class="mini">Generate, copy, and save your daily report. Saves are tracked.</div>

        <div style="margin-top:12px">
          <textarea id="reportText" class="input" placeholder="Click Generate 4pm Draftâ€¦" style="min-height:150px">${escapeHtml(state.ui.reportEditingId ? (current?.text||"") : (state.ui.currentDraft||""))}</textarea>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
          <button class="btn primary" id="btnGenerateHere">${ICON_SAVE} Generate</button>
          <button class="btn" id="btnCopyReport">Copy</button>
          <button class="btn" id="btnSaveReport">${ICON_SAVE} Save</button>
          <button class="btn" id="btnClearReport">Clear</button>
        </div>

        <div style="margin-top:18px">
          <h3 style="margin-bottom:8px">Report Save Log</h3>
          ${renderReportLog()}
        </div>
      </div>
    `;
  }

  function renderReportLog(){
    if(state.reports.length===0){
      return `<div class="mini">No saved reports yet.</div>`;
    }
    const rows = state.reports.map(r => `
      <tr>
        <td class="nowrap">${escapeHtml(r.when)}</td>
        <td style="max-width:520px">${escapeHtml((r.text||"").slice(0,120))}${(r.text||"").length>120?"â€¦":""}</td>
        <td class="rowActions">
          <button class="iconBtn" data-action="edit_report" data-id="${escapeHtml(r.id)}" title="Edit">${ICON_EDIT}</button>
          <button class="iconBtn danger" data-action="del_report" data-id="${escapeHtml(r.id)}" title="Delete">${ICON_TRASH}</button>
        </td>
      </tr>
    `).join("");

    return `
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Date/Time</th><th>Preview</th><th></th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  // -----------------------------
  // Page wiring (events)
  // -----------------------------
  function wirePage(){
    // Tabs (mobile: click on tabs when visible)
    $$(".tab").forEach(t => t.addEventListener("click", () => { state.ui.tab = t.dataset.tab; render(); }));

    // Home KPI pills
    $$("[data-action^='home_']").forEach(el => el.addEventListener("click", () => {
      if(el.dataset.action==="home_needs_reply"){ state.ui.tab="Patients"; state.ui.patientStatus="Needs reply"; state.ui.patientWaiting="all"; state.ui.patientSearch=""; }
      if(el.dataset.action==="home_waiting_clinic"){ state.ui.tab="Patients"; state.ui.patientWaiting="Clinic"; state.ui.patientStatus="all"; state.ui.patientSearch=""; }
      if(el.dataset.action==="home_new_today"){ state.ui.tab="Patients"; state.ui.patientStatus="all"; state.ui.patientWaiting="all"; state.ui.patientSearch=""; }
      if(el.dataset.action==="home_overdue"){ state.ui.tab="Tasks"; state.ui.taskSearch=""; }
      render();
    }));

    // Patients tools
    const ps = $("#patientSearch");
    if(ps){
      ps.addEventListener("input", () => { state.ui.patientSearch = ps.value; saveState(); render(); });
      $("#patientStatusFilter").addEventListener("change", (e)=>{ state.ui.patientStatus = e.target.value; render(); });
      $("#patientWaitingFilter").addEventListener("change", (e)=>{ state.ui.patientWaiting = e.target.value; render(); });
      $("#patientClear").addEventListener("click", ()=>{ state.ui.patientSearch=""; state.ui.patientStatus="all"; state.ui.patientWaiting="all"; render(); });
      $("#btnQuickPatient").addEventListener("click", openQuickPatient);
    }

    // Tasks tools
    const ts = $("#taskSearch");
    if(ts){
      ts.addEventListener("input", () => { state.ui.taskSearch = ts.value; saveState(); render(); });
      $("#taskClear").addEventListener("click", ()=>{ state.ui.taskSearch=""; render(); });
      $("#btnQuickTask").addEventListener("click", openQuickTask);
    }

    // Reports tools
    if($("#reportText")){
      $("#btnGenerateHere").addEventListener("click", () => { generateDraftInto("#reportText"); });
      $("#btnCopyReport").addEventListener("click", copyReport);
      $("#btnSaveReport").addEventListener("click", saveReportFromTextarea);
      $("#btnClearReport").addEventListener("click", ()=>{ state.ui.reportEditingId=null; state.ui.currentDraft=""; render(); });
    }

    // Delegated actions
    $("#page").addEventListener("click", (e)=>{
      const actEl = e.target.closest("[data-action]");
      if(!actEl) return;
      const action = actEl.dataset.action;

      if(action==="open_patient"){
        state.ui.tab="Patients";
        state.ui.patientSearch = actEl.dataset.matter || "";
        state.ui.patientStatus="all";
        state.ui.patientWaiting="all";
        state.assistant.lastMatter = actEl.dataset.matter || null;
        render();
        return;
      }
      if(action==="edit_patient"){ editPatient(actEl.dataset.matter); return; }
      if(action==="del_patient"){ deletePatient(actEl.dataset.matter); return; }
      if(action==="edit_task"){ editTask(actEl.dataset.id); return; }
      if(action==="del_task"){ deleteTask(actEl.dataset.id); return; }
      if(action==="edit_report"){ state.ui.tab="Reports"; state.ui.reportEditingId = actEl.dataset.id; render(); return; }
      if(action==="del_report"){ deleteReport(actEl.dataset.id); return; }
    });

    $("#page").addEventListener("change", (e)=>{
      const sel = e.target.closest("[data-action='p_update'], [data-action='t_update']");
      if(!sel) return;

      if(sel.dataset.action==="p_update"){
        const matter = sel.dataset.matter;
        const field = sel.dataset.field;
        updatePatientField(matter, field, sel.value);
      }
      if(sel.dataset.action==="t_update"){
        const id = sel.dataset.id;
        const field = sel.dataset.field;
        updateTaskField(id, field, sel.value);
      }
    });
  }

  // -----------------------------
  // CRUD: Patients
  // -----------------------------
  function openQuickPatient(){
    openModal("Quick Log â€” Patient", `
      <div class="modalGrid">
        <input class="input" id="ql_matter" placeholder="Matter (ex: 107853)"/>
        <input class="input" id="ql_patient" placeholder="Patient name"/>
        <input class="input" id="ql_state" placeholder="State (ex: OH)"/>
        <select class="input" id="ql_type">${buildOptions(OPTIONS.patientTypes, "MRI")}</select>
        <input class="input" id="ql_provider" placeholder="Provider name"/>
        <input class="input" id="ql_providerEmail" placeholder="Provider email (optional)"/>
        <input class="input" id="ql_req" placeholder="Requested date (YYYY-MM-DD)"/>
        <input class="input" id="ql_sender" placeholder="Sender (Email/Web page/etc)"/>
        <select class="input" id="ql_status">${buildOptions(OPTIONS.patientStatus, "New")}</select>
        <select class="input" id="ql_waiting">${buildOptions(OPTIONS.waitingOn, "Clinic")}</select>
      </div>
      <div style="margin-top:10px">
        <textarea class="input" id="ql_notes" placeholder="Notes" style="min-height:140px"></textarea>
      </div>
    `, "Adds a patient and updates Home + Assistant immediately.", ()=>{
      const p = {
        matter: norm($("#ql_matter").value),
        patient: norm($("#ql_patient").value),
        state: norm($("#ql_state").value),
        type: norm($("#ql_type").value),
        provider: norm($("#ql_provider").value),
        providerEmail: norm($("#ql_providerEmail").value),
        requestedDate: norm($("#ql_req").value),
        sender: norm($("#ql_sender").value),
        status: norm($("#ql_status").value),
        waitingOn: norm($("#ql_waiting").value),
        notes: norm($("#ql_notes").value),
        createdAt: new Date().toISOString()
      };
      if(!p.matter || !p.patient){ alert("Matter and Patient are required."); return; }
      const idx = state.patients.findIndex(x => x.matter===p.matter);
      if(idx>=0) state.patients[idx] = {...state.patients[idx], ...p};
      else state.patients.unshift(p);
      state.assistant.lastMatter = p.matter;
      addAssistantSystem(`Added/updated patient ${p.matter} (${p.patient}).`);
      closeModal();
      render();
    });
  }

  function editPatient(matter){
    const p = state.patients.find(x => x.matter===matter);
    if(!p){ toast("Not found", `Patient ${matter} not found.`); return; }
    openModal(`Edit Patient â€¢ ${matter}`, `
      <div class="modalGrid">
        <input class="input" id="ep_patient" placeholder="Patient name" value="${escapeHtml(p.patient||"")}"/>
        <input class="input" id="ep_state" placeholder="State" value="${escapeHtml(p.state||"")}"/>
        <select class="input" id="ep_type">${buildOptions(OPTIONS.patientTypes, p.type||"MRI")}</select>
        <input class="input" id="ep_provider" placeholder="Provider name" value="${escapeHtml(p.provider||"")}"/>
        <input class="input" id="ep_providerEmail" placeholder="Provider email" value="${escapeHtml(p.providerEmail||"")}"/>
        <input class="input" id="ep_req" placeholder="Requested date" value="${escapeHtml(p.requestedDate||"")}"/>
        <input class="input" id="ep_sender" placeholder="Sender" value="${escapeHtml(p.sender||"")}"/>
        <select class="input" id="ep_status">${buildOptions(OPTIONS.patientStatus, p.status||"New")}</select>
        <select class="input" id="ep_waiting">${buildOptions(OPTIONS.waitingOn, p.waitingOn||"Clinic")}</select>
      </div>
      <div style="margin-top:10px">
        <textarea class="input" id="ep_notes" placeholder="Notes" style="min-height:170px">${escapeHtml(p.notes||"")}</textarea>
      </div>
    `, "Edits are saved to your device.", ()=>{
      Object.assign(p, {
        patient: norm($("#ep_patient").value),
        state: norm($("#ep_state").value),
        type: norm($("#ep_type").value),
        provider: norm($("#ep_provider").value),
        providerEmail: norm($("#ep_providerEmail").value),
        requestedDate: norm($("#ep_req").value),
        sender: norm($("#ep_sender").value),
        status: norm($("#ep_status").value),
        waitingOn: norm($("#ep_waiting").value),
        notes: norm($("#ep_notes").value)
      });
      addAssistantSystem(`Updated patient ${matter}.`);
      closeModal();
      render();
    });
  }

  function deletePatient(matter){
    if(!confirm(`Delete patient ${matter}?`)) return;
    state.patients = state.patients.filter(p => p.matter!==matter);
    addAssistantSystem(`Deleted patient ${matter}.`);
    render();
  }

  function updatePatientField(matter, field, value){
    const p = state.patients.find(x => x.matter===matter);
    if(!p) return;
    p[field] = norm(value);
    // auto: if waitingOn Clinic and status empty, keep status
    addAssistantSystem(`Patient ${matter}: set ${field} â†’ ${p[field]}`);
    render(); // updates KPIs
  }

  // -----------------------------
  // CRUD: Tasks
  // -----------------------------
  function openQuickTask(){
    openModal("Quick Log â€” Task", `
      <div class="modalGrid">
        <input class="input" id="qt_matter" placeholder="Matter (ex: 107853)"/>
        <select class="input" id="qt_priority">${buildOptions(OPTIONS.taskPriority, "Medium")}</select>
        <select class="input" id="qt_type">${buildOptions(OPTIONS.taskType, "Follow-up clinic")}</select>
        <select class="input" id="qt_progress">${buildOptions(OPTIONS.taskProgress, "Open")}</select>
      </div>
      <div style="margin-top:10px">
        <textarea class="input" id="qt_desc" placeholder="Description" style="min-height:130px"></textarea>
      </div>
    `, "Adds a task. You can edit later.", ()=>{
      const t = {
        id: cryptoId(),
        matter: norm($("#qt_matter").value),
        priority: norm($("#qt_priority").value),
        taskType: norm($("#qt_type").value),
        progress: norm($("#qt_progress").value),
        description: norm($("#qt_desc").value),
        createdAt: new Date().toISOString()
      };
      if(!t.matter || !t.description){ alert("Matter and Description are required."); return; }
      state.tasks.unshift(t);
      state.assistant.lastMatter = t.matter;
      addAssistantSystem(`Added task for matter ${t.matter}.`);
      closeModal();
      render();
    });
  }

  function editTask(id){
    const t = state.tasks.find(x => x.id===id);
    if(!t){ toast("Not found","Task not found."); return; }
    openModal("Edit Task", `
      <div class="modalGrid">
        <input class="input" id="et_matter" placeholder="Matter" value="${escapeHtml(t.matter||"")}"/>
        <select class="input" id="et_priority">${buildOptions(OPTIONS.taskPriority, t.priority||"Medium")}</select>
        <select class="input" id="et_type">${buildOptions(OPTIONS.taskType, t.taskType||"Follow-up clinic")}</select>
        <select class="input" id="et_progress">${buildOptions(OPTIONS.taskProgress, t.progress||"Open")}</select>
      </div>
      <div style="margin-top:10px">
        <textarea class="input" id="et_desc" style="min-height:140px">${escapeHtml(t.description||"")}</textarea>
      </div>
    `, "Edits are saved to your device.", ()=>{
      Object.assign(t, {
        matter: norm($("#et_matter").value),
        priority: norm($("#et_priority").value),
        taskType: norm($("#et_type").value),
        progress: norm($("#et_progress").value),
        description: norm($("#et_desc").value)
      });
      addAssistantSystem(`Updated a task for ${t.matter}.`);
      closeModal();
      render();
    });
  }

  function deleteTask(id){
    if(!confirm("Delete this task?")) return;
    state.tasks = state.tasks.filter(t => t.id!==id);
    addAssistantSystem("Deleted a task.");
    render();
  }

  function updateTaskField(id, field, value){
    const t = state.tasks.find(x => x.id===id);
    if(!t) return;
    t[field] = norm(value);
    addAssistantSystem(`Task updated: ${field} â†’ ${t[field]}`);
    render();
  }

  // -----------------------------
  // Reports
  // -----------------------------
  function generateDraft(){
    const openTasks = state.tasks.filter(t => lower(t.progress)==="open");
    const needsReply = state.patients.filter(p => lower(p.status)==="needs reply");
    const waitingClinic = state.patients.filter(p => lower(p.waitingOn)==="clinic" && lower(p.status)!=="done");

    const lines = [];
    lines.push(`4pm Report â€” ${nowStamp()}`);
    lines.push("");
    lines.push(`Patients waiting on clinic: ${waitingClinic.length}`);
    for(const p of waitingClinic.slice(0,12)){
      lines.push(`- ${p.matter}: ${p.patient} â€¢ ${p.type||""} â€¢ Provider: ${p.provider||""} â€¢ Status: ${p.status||""} â€¢ Notes: ${p.notes||""}`.trim());
    }
    lines.push("");
    lines.push(`Needs reply: ${needsReply.length}`);
    for(const p of needsReply.slice(0,12)){
      lines.push(`- ${p.matter}: ${p.patient} â€¢ Provider: ${p.provider||""} â€¢ Notes: ${p.notes||""}`.trim());
    }
    lines.push("");
    lines.push(`Open tasks: ${openTasks.length}`);
    for(const t of openTasks.slice(0,18)){
      lines.push(`- ${t.matter}: [${t.priority}] ${t.taskType} â€” ${t.description}`.trim());
    }
    lines.push("");
    lines.push("End.");
    return lines.join("\n");
  }

  function generateDraftInto(selector){
    const draft = generateDraft();
    const ta = $(selector);
    if(ta) ta.value = draft;
    state.ui.currentDraft = draft;
    state.ui.reportEditingId = null;
    toast("Draft generated","4pm draft was generated from current Patients + Tasks.");
    render(); // ensures textarea reflects currentDraft in Reports tab too
    // if not on Reports, keep it stored
  }

  function copyReport(){
    const ta = $("#reportText");
    if(!ta) return;
    navigator.clipboard?.writeText(ta.value).then(()=> toast("Copied","Report copied to clipboard."), ()=> toast("Copy failed","Your browser blocked clipboard access."));
  }

  function saveReportFromTextarea(){
    const ta = $("#reportText");
    if(!ta) return;
    const text = norm(ta.value);
    if(!text){ toast("Nothing to save","Generate or type a report first."); return; }

    if(state.ui.reportEditingId){
      const r = state.reports.find(x => x.id===state.ui.reportEditingId);
      if(r) r.text = text;
      toast("Saved","Updated existing saved report.");
    }else{
      state.reports.unshift({ id: cryptoId(), when: nowStamp(), text });
      toast("Saved","Report saved to log.");
    }
    state.ui.reportEditingId = null;
    state.ui.currentDraft = text;
    render();
  }

  function deleteReport(id){
    if(!confirm("Delete this saved report?")) return;
    state.reports = state.reports.filter(r => r.id!==id);
    if(state.ui.reportEditingId===id) state.ui.reportEditingId=null;
    toast("Deleted","Saved report removed.");
    render();
  }

  // -----------------------------
  // Assistant
  // -----------------------------
  function renderAssistant(){
    const panel = $("#assistant");
    panel.style.display = state.assistant.open ? "block" : "none";
    $("#pendingCount").textContent = String(state.assistant.pending||0);

    const body = $("#assistantBody");
    const chat = state.assistant.chat || [];
    body.innerHTML = chat.map(m => `
      <div class="bubble ${m.role==="me"?"me":""}">
        ${escapeHtml(m.text)}
        ${m.meta ? `<div class="small">${escapeHtml(m.meta)}</div>` : ""}
      </div>
    `).join("");

    // autoscroll
    body.scrollTop = body.scrollHeight;
  }

  function addAssistant(role, text, meta){
    state.assistant.chat.push({ role, text, meta: meta||"" });
    saveState();
    renderAssistant();
  }
  function addAssistantSystem(text){
    addAssistant("sys", text);
  }

  function parseMatterFromText(s){
    const m = s.match(/\bM?-?\s*(\d{4,})\b/i);
    return m ? m[1] : null;
  }

  function assistantRespond(input){
    const msg = lower(input);

    // Commands
    if(msg.includes("show needs reply") || msg==="needs reply"){
      state.ui.tab="Patients"; state.ui.patientStatus="Needs reply"; state.ui.patientWaiting="all"; state.ui.patientSearch="";
      addAssistant("sys","Showing patients/tasks that need reply.");
      render(); return;
    }

    if(msg.startsWith("open ")){
      const matter = parseMatterFromText(input) || state.assistant.lastMatter;
      if(matter){
        state.ui.tab="Patients";
        state.ui.patientSearch = matter;
        state.ui.patientStatus="all";
        state.ui.patientWaiting="all";
        state.assistant.lastMatter = matter;
        addAssistant("sys",`Opening matter ${matter} in Patients.`);
        render(); return;
      }
    }

    // "give an update about <name>"
    if(msg.includes("give an update") || msg.includes("update about")){
      const name = input.split(/about/i)[1]?.trim();
      const p = name ? state.patients.find(x => lower(x.patient).includes(lower(name))) : null;
      if(p){
        state.assistant.lastMatter = p.matter;
        addAssistant("sys", `Patient: ${p.patient} â€¢ Matter: ${p.matter} â€¢ Type: ${p.type||""} â€¢ Provider: ${p.provider||""} â€¢ Status: ${p.status||""} â€¢ Waiting On: ${p.waitingOn||""} â€¢ Requested: ${p.requestedDate||""}\nNotes: ${p.notes||""}`);
      }else{
        addAssistant("sys", "I couldn't find that patient name in your list yet.");
      }
      return;
    }

    // Update patient by structured params: update patient 107853 status=... waitingOn=...
    if(msg.includes("update patient") || msg.includes("update the patient") || msg.includes("update the patient file")){
      const matter = parseMatterFromText(input) || state.assistant.lastMatter;
      if(!matter){
        addAssistant("sys","Tell me the matter number (ex: update patient 107853 waitingOn=Clinic).");
        return;
      }
      const p = state.patients.find(x => x.matter===matter);
      if(!p){
        addAssistant("sys", `I can't update matter ${matter} because it isn't in Patients yet.`);
        return;
      }

      // Natural language: "to waiting on clinic"
      if(msg.includes("waiting on clinic") || msg.includes("waiting-on clinic")){
        p.waitingOn = "Clinic";
        if(!p.status) p.status = "Sent to clinic";
        state.assistant.lastMatter = matter;
        addAssistant("sys", `Updated patient ${matter}: waitingOn â†’ Clinic.`);
        render();
        return;
      }

      // Parse key=value pairs
      const pairs = Array.from(input.matchAll(/\b(status|waitingOn|type|provider|state|patient|sender|requestedDate)\s*=\s*([^,\n]+)/gi));
      if(pairs.length===0){
        addAssistant("sys","Tell me what to change. Example: update patient 107853 status=Needs reply waitingOn=You");
        return;
      }
      for(const [,k,v] of pairs){
        const key = k.trim();
        p[key] = norm(v);
      }
      state.assistant.lastMatter = matter;
      addAssistant("sys", `Updated patient ${matter}.`);
      render();
      return;
    }

    // fallback: if message includes a matter number, show summary
    const m = parseMatterFromText(input);
    if(m){
      const p = state.patients.find(x => x.matter===m);
      if(p){
        state.assistant.lastMatter = p.matter;
        addAssistant("sys", `Patient: ${p.patient} â€¢ Matter: ${p.matter} â€¢ Status: ${p.status||""} â€¢ Waiting On: ${p.waitingOn||""} â€¢ Provider: ${p.provider||""}\nNotes: ${p.notes||""}`);
      }else{
        addAssistant("sys", `I don't have matter ${m} saved yet. Add it via Quick Log â†’ Patient.`);
      }
      return;
    }

    addAssistant("sys","Try: â€¢ show needs reply â€¢ open 107853 â€¢ give an update about <name> â€¢ update patient 107853 waitingOn=Clinic");
  }

  // -----------------------------
  // CSV download (Excel-friendly)
  // -----------------------------
  function downloadCSV(){
    const headers = ["Matter","Patient","State","Type","Provider","Provider Email","Requested Date","Sender","Status","Waiting On","Notes"];
    const rows = state.patients.map(p => [
      p.matter,p.patient,p.state,p.type,p.provider,p.providerEmail,p.requestedDate,p.sender,p.status,p.waitingOn,p.notes
    ]);
    const csv = [headers, ...rows].map(r => r.map(v => {
      const s = (v??"").toString().replace(/"/g,'""');
      return `"${s}"`;
    }).join(",")).join("\n");

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `command-center-patients-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2000);
  }

  // -----------------------------
  // Top-level buttons
  // -----------------------------
  $("#btnToggleAssistant").addEventListener("click", ()=>{
    state.assistant.open = !state.assistant.open;
    render();
  });

  $("#btnDownload").addEventListener("click", downloadCSV);

  $("#btnGenerate").addEventListener("click", ()=>{
    // Generate draft and route to Reports
    state.ui.tab = "Reports";
    state.ui.reportEditingId = null;
    state.ui.currentDraft = generateDraft();
    toast("Draft generated","Opened Reports with a new 4pm draft.");
    render();
  });

  $("#assistantSend").addEventListener("click", ()=>{
    const input = $("#assistantInput");
    const text = norm(input.value);
    if(!text) return;
    addAssistant("me", text);
    input.value = "";
    assistantRespond(text);
  });

  $("#assistantInput").addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); $("#assistantSend").click(); }
  });

  // If something breaks, show it.
  window.addEventListener("error", (e)=>{
    console.error(e.error||e.message);
    toast("Script error", "Something crashed. Refresh and try again. If it persists, tell me what you clicked.");
  });

  // First render
  render();
})();
</script>
</body>
</html>
