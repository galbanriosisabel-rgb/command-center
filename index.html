<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Command Center ‚Äì Prototype (Isabel) v4</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#11151b; --panel2:#0f1318; --card:#141a22;
      --text:#e7e9ee; --muted:#aab0bd; --border:#263244;
      --red:#d10f2f; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --link:#7dd3fc;
      --shadow:0 12px 30px rgba(0,0,0,.35); --r:18px; --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(209,15,47,.25), transparent 55%),
        radial-gradient(900px 600px at 95% 10%, rgba(125,211,252,.12), transparent 55%),
        var(--bg);
    }
    a{color:var(--link);text-decoration:none} a:hover{text-decoration:underline}
    .app{display:grid;grid-template-columns:260px 1fr 360px;gap:14px;padding:14px;height:100vh}
    body.assistant-collapsed .app{grid-template-columns:260px 1fr}
    .sidebar,.main,.assistant{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--panel);
      border:1px solid rgba(38,50,68,.9);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden
    }
    body.assistant-collapsed .assistant{display:none}
    .sidebar{display:flex;flex-direction:column}
    .brand{padding:16px 16px 12px;border-bottom:1px solid rgba(38,50,68,.7);
      background:linear-gradient(180deg, rgba(209,15,47,.12), transparent 70%)}
    .title{display:flex;align-items:center;gap:10px;font-weight:900}
    .dot{width:11px;height:11px;border-radius:999px;background:var(--red);box-shadow:0 0 0 6px rgba(209,15,47,.16)}
    .sub{margin-top:6px;color:var(--muted);font-size:12.5px;line-height:1.25}
    .nav{padding:10px}
    .nav button{width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;margin:6px 0;border-radius:14px;
      border:1px solid transparent;background:transparent;color:var(--text);cursor:pointer;font-weight:800;text-align:left}
    .nav button:hover{background:rgba(255,255,255,.03);border-color:rgba(38,50,68,.7)}
    .nav button.active{background:rgba(209,15,47,.12);border-color:rgba(209,15,47,.35)}
    .pill{margin-left:auto;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid rgba(38,50,68,.8);
      color:var(--muted);background:rgba(255,255,255,.02)}
    .footer{margin-top:auto;padding:12px 14px;border-top:1px solid rgba(38,50,68,.7);color:var(--muted);font-size:12px;display:flex;justify-content:space-between}
    .kbd{font-family:var(--mono);border:1px solid rgba(38,50,68,.8);background:rgba(255,255,255,.03);padding:2px 6px;border-radius:8px;color:var(--text)}

    .main{display:flex;flex-direction:column;min-width:0}
    .topbar{padding:14px 16px;border-bottom:1px solid rgba(38,50,68,.7);display:flex;align-items:center;justify-content:space-between;
      background:linear-gradient(90deg, rgba(209,15,47,.10), transparent 45%);gap:10px}
    .topbar h1{font-size:16px;margin:0}
    .meta{color:var(--muted);font-size:12.5px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .btn{border:1px solid rgba(38,50,68,.9);background:rgba(255,255,255,.03);color:var(--text);
      padding:9px 10px;border-radius:12px;cursor:pointer;font-weight:900;font-size:12.5px;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{background:rgba(255,255,255,.05)}
    .btn.primary{border-color:rgba(209,15,47,.45);background:rgba(209,15,47,.15)}
    .btn.primary:hover{background:rgba(209,15,47,.22)}
    .btn.small{padding:7px 9px;font-size:12px;border-radius:10px}
    .btn.ghost{background:transparent}
    .btn.danger{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.15)}
    .btn.danger:hover{background:rgba(239,68,68,.22)}
    .content{padding:14px;overflow:auto;min-width:0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;min-width:0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card);
      border:1px solid rgba(38,50,68,.85);border-radius:var(--r2);padding:12px;min-height:90px;min-width:0}
    .card h3{margin:0 0 8px;font-size:13px;letter-spacing:.2px}
    .kpi{display:flex;align-items:baseline;gap:8px;margin-top:8px}
    .num{font-size:26px;font-weight:900}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(38,50,68,.9);
      background:rgba(255,255,255,.02);font-size:12px;color:var(--muted);white-space:nowrap}
    .tag.click{cursor:pointer}
    .tag.click:hover{border-color:rgba(125,211,252,.35)}
    .dot2{width:7px;height:7px;border-radius:999px;background:var(--muted)}
    .dot2.ok{background:var(--ok)} .dot2.warn{background:var(--warn)} .dot2.bad{background:var(--bad)}
    .tablewrap{overflow:auto;border-radius:14px;border:1px solid rgba(38,50,68,.85)}
    .table{width:100%;border-collapse:separate;border-spacing:0;min-width:860px}
    .table th,.table td{padding:11px 12px;border-bottom:1px solid rgba(38,50,68,.65);font-size:12.5px;vertical-align:top}
    .table th{color:var(--muted);background:rgba(255,255,255,.02);font-weight:900;position:sticky;top:0;z-index:2}
    .table tr:last-child td{border-bottom:none}
    .badge{display:inline-flex;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid rgba(38,50,68,.9);background:rgba(255,255,255,.02)}
    .badge.red{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.12)}
    .badge.orange{border-color:rgba(245,158,11,.45);background:rgba(245,158,11,.12)}
    .badge.green{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12)}
    .badge.gray{border-color:rgba(148,163,184,.35);background:rgba(148,163,184,.08);color:var(--muted)}
    .searchrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .input,select,textarea{background:rgba(255,255,255,.03);border:1px solid rgba(38,50,68,.9);color:var(--text);border-radius:12px;padding:9px 10px;font-size:12.5px;outline:none}
    textarea{min-height:70px;resize:vertical}
    .input::placeholder{color:rgba(170,176,189,.7)} select{cursor:pointer}
    .note{font-size:12px;color:var(--muted);line-height:1.3}
    .page{display:none} .page.active{display:block}
    .table td .cell{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .cell select{padding:7px 8px;border-radius:10px;font-size:12px}
    .cell .btn{padding:7px 9px;font-size:12px;border-radius:10px}
    .action-buttons{display:flex;gap:6px;flex-wrap:wrap}
    .action-buttons .btn{padding:6px 8px;font-size:11px;min-width:60px}

    .assistant{display:flex;flex-direction:column;min-width:0}
    .ahead{padding:14px 14px 12px;border-bottom:1px solid rgba(38,50,68,.7);
      background:linear-gradient(180deg, rgba(209,15,47,.10), transparent 70%);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .ahead .h{display:flex;align-items:center;gap:10px;font-weight:900;font-size:13.5px}
    .chat{padding:12px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:10px}
    .bubble{max-width:92%;padding:10px;border-radius:16px;border:1px solid rgba(38,50,68,.9);background:rgba(255,255,255,.02);font-size:12.8px;line-height:1.25}
    .bubble.me{margin-left:auto;background:rgba(125,211,252,.08);border-color:rgba(125,211,252,.20)}
    .bubble.bot{background:rgba(209,15,47,.10);border-color:rgba(209,15,47,.22)}
    .composer{border-top:1px solid rgba(38,50,68,.7);padding:10px;display:flex;gap:8px;align-items:center;background:var(--panel2)}
    .composer input{flex:1}

    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .backdrop.show{display:flex}
    .modal{width:min(960px, 100%);background:var(--panel);border:1px solid rgba(38,50,68,.9);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .modal .mhead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 14px 12px;border-bottom:1px solid rgba(38,50,68,.7);
      background:linear-gradient(90deg, rgba(209,15,47,.10), transparent 45%)}
    .modal .mhead .mtitle{font-weight:950}
    .modal .mbody{padding:14px;max-height:70vh;overflow-y:auto}
    .formgrid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col3{grid-column:span 3}
    .col4{grid-column:span 4}
    .col6{grid-column:span 6}
    .col8{grid-column:span 8}
    .col12{grid-column:span 12}
    .helper{font-size:12px;color:var(--muted);margin-top:6px}
    .email-preview{background:rgba(255,255,255,.02);border:1px solid rgba(38,50,68,.85);border-radius:14px;padding:12px;margin-top:10px;font-family:var(--mono);font-size:12px;line-height:1.4;white-space:pre-wrap}

    @media (max-width:1180px){.app{grid-template-columns:250px 1fr;grid-template-rows:1fr 360px} .assistant{grid-column:1/-1}}
    @media (max-width:820px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr 360px}}
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="title"><span class="dot"></span> Command Center</div>
      <div class="sub">Isabel ‚Ä¢ InjuryRX<br><span class="muted">Patients ‚Ä¢ Tasks ‚Ä¢ Notes ‚Ä¢ Providers ‚Ä¢ Reports</span></div>
    </div>
    <nav class="nav">
      <button class="active" data-page="home">üè† Home <span class="pill">Today</span></button>
      <button data-page="patients">üë• Patients <span class="pill">Active</span></button>
      <button data-page="tasks">‚úÖ Tasks <span class="pill">Priority</span></button>
      <button data-page="notes">üìù Notes <span class="pill">Log</span></button>
      <button data-page="providers">üè• Providers <span class="pill">Directory</span></button>
      <button data-page="reports">üìä Reports <span class="pill">4pm</span></button>
    </nav>
    <div class="footer"><span>Shortcuts</span><span><span class="kbd">Ctrl</span> + <span class="kbd">K</span></span></div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div>
        <h1 id="pageTitle">Home</h1>
        <div class="meta" id="pageSubtitle">Quick view of what matters today</div>
      </div>
      <div class="actions">
        <button class="btn" id="btnToggleAssistant">üóÇÔ∏è Toggle Assistant</button>
        <button class="btn" id="btnQuickLog">‚ûï Quick Log</button>
        <button class="btn" id="btnDownloadExcel">‚¨áÔ∏è Download Excel</button>
        <button class="btn primary" id="btnGenerateReport">üßæ Generate 4pm Draft</button>
      </div>
    </div>

    <div class="content">
      <!-- HOME -->
      <section class="page active" id="page-home">
        <div class="grid">
          <div class="card" style="grid-column:span 3">
            <h3>üî¥ Overdue today</h3>
            <div class="kpi"><div class="num" id="kpiOverdue">0</div><div class="note">cases</div></div>
            <div class="tag click" data-homefilter="overdue"><span class="dot2 bad"></span> follow-up overdue</div>
          </div>
          <div class="card" style="grid-column:span 3">
            <h3>üìß Needs reply</h3>
            <div class="kpi"><div class="num" id="kpiNeedsReply">0</div><div class="note">actions</div></div>
            <div class="tag click" data-homefilter="needs_reply"><span class="dot2 warn"></span> reply today</div>
          </div>
          <div class="card" style="grid-column:span 3">
            <h3>üÜï New today</h3>
            <div class="kpi"><div class="num" id="kpiNew">0</div><div class="note">patients</div></div>
            <div class="tag click" data-homefilter="new_today"><span class="dot2 ok"></span> created today</div>
          </div>
          <div class="card" style="grid-column:span 3">
            <h3>‚è≥ Waiting on clinic</h3>
            <div class="kpi"><div class="num" id="kpiWaiting">0</div><div class="note">cases</div></div>
            <div class="tag click" data-homefilter="waiting_clinic"><span class="dot2"></span> no response</div>
          </div>

          <div class="card" style="grid-column:span 7;min-width:0">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <h3 style="margin:0">üìå Priority (Today)</h3>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span class="tag" id="homeFilterTag" title="Current Home filter">All</span>
                <button class="btn small" id="btnClearHomeFilter">Clear</button>
              </div>
            </div>
            <div class="tablewrap" style="margin-top:10px">
              <table class="table">
                <thead>
                  <tr>
                    <th>Matter</th><th>Patient</th><th>State</th><th>Type</th>
                    <th>Status</th><th>Waiting On</th><th>Next Step</th><th>Due</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tblPriority"></tbody>
              </table>
            </div>
            <div class="note" style="margin-top:10px">Tip: click a KPI tag above (ex: <b>reply today</b>) to filter the list.</div>
          </div>

          <div class="card" style="grid-column:span 5;min-width:0">
            <h3>üì• Action Inbox (Email ‚Üí Tasks)</h3>
            <div class="tablewrap" style="margin-top:10px">
              <table class="table" style="min-width:720px">
                <thead><tr><th>Type</th><th>Matter</th><th>Subject</th><th>Due</th><th>Provider Email</th><th>Action</th></tr></thead>
                <tbody id="tblEmailActions"></tbody>
              </table>
            </div>
            <div class="note" style="margin-top:10px">Click "Email" to preview and send email to provider.</div>
          </div>
        </div>
      </section>

      <!-- PATIENTS -->
      <section class="page" id="page-patients">
        <div class="searchrow">
          <input class="input" id="patientSearch" placeholder="Search by patient, matter, state‚Ä¶" />
          <select id="filterStatus"><option value="">Status (all)</option></select>
          <select id="filterWaiting"><option value="">Waiting On (all)</option></select>
          <button class="btn" id="btnClearPatients">Clear</button>
        </div>
        <div class="card">
          <h3>üë• Patients</h3>
          <div class="tablewrap" style="margin-top:10px">
            <table class="table" style="min-width:1200px">
              <thead>
                <tr>
                  <th>Matter</th><th>Patient</th><th>State</th><th>Type</th><th>Provider</th>
                  <th>Requested Date</th><th>Sender</th><th>Status</th><th>Waiting On</th><th>Notes</th><th>Due</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="tblPatients"></tbody>
            </table>
          </div>
          <div class="note" style="margin-top:10px">Quick Log adds a new patient row (auto-saved on your device).</div>
        </div>
      </section>

      <!-- TASKS -->
      <section class="page" id="page-tasks">
        <div class="searchrow">
          <input class="input" id="taskSearch" placeholder="Search tasks (patient, subject, provider‚Ä¶)" />
          <select id="filterTaskStatus"><option value="">Progress (all)</option></select>
          <select id="filterTaskType"><option value="">Task Type (all)</option></select>
          <button class="btn" id="btnClearTasks">Clear</button>
        </div>
        <div class="grid">
          <div class="card" style="grid-column:span 8;min-width:0">
            <h3>‚úÖ Tasks</h3>
            <div class="tablewrap" style="margin-top:10px">
              <table class="table" style="min-width:940px">
                <thead>
                  <tr>
                    <th>Priority</th><th>Task Type</th><th>Matter</th><th>Description</th><th>Progress</th><th>Due</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tblTasks"></tbody>
              </table>
            </div>
            <div class="note" style="margin-top:10px">Use Progress = <b>Done</b> or <b>Updated</b> to stop follow-ups.</div>
          </div>
          <div class="card" style="grid-column:span 4">
            <h3>üìå Quick Buttons</h3>
            <div class="note">In the real version these trigger Power Automate / Power Apps.</div>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px">
              <button class="btn" onclick="quickTask('Follow-up clinic','Follow-up in 48h')">‚ûï Follow-up 48h</button>
              <button class="btn" onclick="quickTask('Reply email','Reply to clinic email')">‚ûï Reply email</button>
              <button class="btn" onclick="quickTask('Update Clio','Update note/status in Clio')">‚ûï Update Clio</button>
              <button class="btn primary" onclick="quickTask('Send referral','Send referral to provider')">‚ûï Send referral</button>
            </div>
          </div>
        </div>
      </section>

      <!-- NOTES -->
      <section class="page" id="page-notes">
        <div class="grid">
          <div class="card" style="grid-column:span 7;min-width:0">
            <h3>üìù Notes Log</h3>
            <div class="note">This is your audit trail for quick saves (including "Reports" saves).</div>
            <div class="tablewrap" style="margin-top:10px">
              <table class="table" style="min-width:900px">
                <thead><tr><th>Date/Time</th><th>Section</th><th>Reference</th><th>Note</th></tr></thead>
                <tbody id="tblNotesLog"></tbody>
              </table>
            </div>
          </div>
          <div class="card" style="grid-column:span 5;min-width:0">
            <h3>‚úâÔ∏è Email Provider</h3>
            <div class="note">Choose a patient + provider and it will preview the draft template.</div>
            <div style="display:grid;gap:10px;margin-top:10px">
              <input class="input" id="emailMatterSearch" placeholder="Search by Matter # (optional)" />
              <select id="emailPatientPick"></select>
              <select id="emailProviderPick"></select>
              <button class="btn primary" id="btnOpenEmailDraft">Preview Email Draft</button>
              <div class="note">Tip: if a provider has no email yet, add it using Quick Log on this page.</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>üè• Provider Directory (same table as Providers)</h3>
          <div class="note">Quick Log on this page adds a provider (including email).</div>
          <div class="tablewrap" style="margin-top:10px">
            <table class="table" style="min-width:980px">
              <thead><tr><th>Provider</th><th>States</th><th>Services</th><th>Email</th><th>Method</th><th>Notes</th><th>Action</th></tr></thead>
              <tbody id="tblProvidersInNotes"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PROVIDERS -->
      <section class="page" id="page-providers">
        <div class="searchrow">
          <input class="input" id="providerSearch" placeholder="Search provider (name, state, service‚Ä¶)" />
          <select id="filterService"><option value="">Service (all)</option></select>
          <select id="filterProviderState"><option value="">State (all)</option></select>
          <button class="btn" id="btnClearProviders">Clear</button>
        </div>
        <div class="card">
          <h3>üè• Providers Directory</h3>
          <div class="tablewrap" style="margin-top:10px">
            <table class="table" style="min-width:980px">
              <thead><tr><th>Provider</th><th>States</th><th>Services</th><th>Email</th><th>Method</th><th>Notes</th><th>Action</th></tr></thead>
              <tbody id="tblProviders"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS -->
      <section class="page" id="page-reports">
        <div class="grid">
          <div class="card" style="grid-column:span 12;min-width:0">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
              <div>
                <h3 style="margin:0 0 6px">üßæ 4pm Report Draft</h3>
                <div class="note">Mark as Reported and store the completion date/time (auto-saved).</div>
              </div>
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <label class="tag" style="cursor:pointer">
                  <input id="reportedChk" type="checkbox" style="accent-color: var(--red); transform: translateY(1px);" />
                  Reported
                </label>
                <input class="input" id="reportedDate" type="datetime-local" />
                <button class="btn small primary" id="btnSaveReportMeta">Save</button>
              </div>
            </div>

            <div style="margin-top:12px; display:grid; grid-template-columns: 1fr; gap:12px;">
              <pre id="reportDraft" style="white-space:pre-wrap;background:rgba(255,255,255,.03);border:1px solid rgba(38,50,68,.85);
                padding:12px;border-radius:14px;font-family:var(--mono);font-size:12px;line-height:1.35;min-height:220px;overflow:auto"></pre>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn primary" onclick="copyReport()">üìã Copy</button>
                <button class="btn" onclick="regenerateReport()">üîÑ Regenerate</button>
                <button class="btn" onclick="downloadCurrentPageExcel()">‚¨áÔ∏è Download Excel (Report)</button>
              </div>
              <div class="note" id="reportMetaNote"></div>
            </div>

            <div style="margin-top:14px">
              <h3 style="margin:0 0 8px">üóÇÔ∏è Report Save Log</h3>
              <div class="note">Each time you hit <b>Save</b>, we store a record here so you can track later.</div>
              <div class="tablewrap" style="margin-top:10px">
                <table class="table" style="min-width:900px">
                  <thead><tr><th>Date/Time</th><th>Reported?</th><th>Reported Date</th><th>Draft Preview</th><th>Actions</th></tr></thead>
                  <tbody id="tblReportLog"></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </section>
    </div>
  </main>

  <aside class="assistant">
    <div class="ahead">
      <div class="h"><span class="dot"></span> Isabel's Assistant</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tag"><span class="dot2 warn"></span> <span id="pendingCount">0</span> pending</div>
        <button class="btn small" id="btnCollapseAssistant" title="Collapse">‚§µ</button>
      </div>
    </div>
    <div class="chat" id="chat">
      <div class="bubble bot">Hi Isabel üëã. I can help you: <b>send emails to providers</b>, <b>update patient info</b>, <b>filter by needs reply</b>, or <b>open specific matters</b>.</div>
      <div class="bubble bot">Try commands like: <br>‚Ä¢ "send email for M-10231"<br>‚Ä¢ "update status of M-10244 to Scheduled"<br>‚Ä¢ "show needs reply"<br>‚Ä¢ "open M-10255"</div>
    </div>
    <div class="composer">
      <input class="input" id="msg" placeholder="Example: 'send email for M-10231' or 'update M-10244 status to Scheduled'"/>
      <button class="btn primary" id="send">Send</button>
    </div>
  </aside>
</div>

<!-- Quick Log Modal -->
<div class="backdrop" id="modalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Quick Log">
    <div class="mhead">
      <div class="mtitle" id="quickLogTitle">‚ûï Quick Log</div>
      <button class="btn small" onclick="closeModal()">‚úï</button>
    </div>
    <div class="mbody">
      <div id="quickLogBody"></div>
    </div>
  </div>
</div>

<!-- Email Preview Modal -->
<div class="backdrop" id="emailModalBackdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Email Preview" style="max-width:800px;">
    <div class="mhead">
      <div class="mtitle" id="emailModalTitle">‚úâÔ∏è Email Preview</div>
      <button class="btn small" onclick="closeEmailModal()">‚úï</button>
    </div>
    <div class="mbody">
      <div id="emailModalBody"></div>
    </div>
  </div>
</div>


<script>
  // =============================
  //  Local Storage (Auto-save)
  // =============================
  const LS_KEY = "injuryrx_command_center_v4";

  function nowIso(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){ return null; }
  }
  function saveState(){
    try{
      localStorage.setItem(LS_KEY, JSON.stringify({
        patients, tasks, providers, priorityRows, emailActions,
        notesLog, reportMeta, reportLog
      }));
    }catch(e){}
  }

  // =============================
  //  Dropdown lists
  // =============================
  const STATUS_OPTIONS = ["New","Sent to clinic","Clinic confirmed","Scheduled","Seen","Pending records","Closed","Stuck"];
  const WAITING_OPTIONS = ["Clinic","You","Patient","Internal"];
  const TYPE_OPTIONS = ["Chiro/PT","PT","MRI","Pain Mgmt","Ortho","Other"];
  const TASK_TYPE_OPTIONS = ["Reply email","Follow-up clinic","Send referral","Update Clio","Other"];
  const TASK_PROGRESS_OPTIONS = ["Open","Waiting","Done","Updated"];
  const SERVICE_OPTIONS = ["Chiro/PT","MRI","Pain Mgmt","Ortho","Other"];

  // =============================
  //  Default demo data
  // =============================
  const demo = {
    priorityRows: [
      {matter:"M-10231", patient:"Ana Gomez", state:"GA", type:"MRI", status:"Stuck", waiting:"Clinic", next:"Follow-up MRI (call)", due:"Today", providerEmail:"referrals@peachtreeimaging.com"},
      {matter:"M-10244", patient:"Carlos Ruiz", state:"FL", type:"PT", status:"Sent to clinic", waiting:"Clinic", next:"Confirm PT appointment", due:"Today", providerEmail:"intake@sunriserehab.com"},
      {matter:"M-10255", patient:"Maria Lopez", state:"TX", type:"Chiro/PT", status:"New", waiting:"You", next:"Assign provider", due:"Today", providerEmail:""},
      {matter:"M-10202", patient:"Juan Perez", state:"GA", type:"Pain Mgmt", status:"Scheduled", waiting:"Internal", next:"Request post-visit records", due:"Tomorrow", providerEmail:""},
    ],
    emailActions: [
      {type:"Needs reply", matter:"M-10255", subject:"Need DOB/DOA for referral", due:"Today", providerEmail:"intake@sunriserehab.com"},
      {type:"Needs reply", matter:"M-10231", subject:"MRI order required", due:"Today", providerEmail:"referrals@peachtreeimaging.com"},
      {type:"Follow-up", matter:"M-10188", subject:"Records status update", due:"Today", providerEmail:"records@bayimaging.com"},
    ],
    patients: [
      {matter:"M-10255", patient:"Maria Lopez", state:"TX", type:"Chiro/PT", provider:"‚Äî", requestedDate:"2026-01-08", sender:"Slack", status:"New", waiting:"You", notes:"Assign TX provider", due:"2026-01-08"},
      {matter:"M-10231", patient:"Ana Gomez", state:"GA", type:"MRI", provider:"Peachtree Imaging", requestedDate:"2026-01-08", sender:"Email", status:"Stuck", waiting:"Clinic", notes:"Need MRI order + confirm slot", due:"2026-01-08"},
      {matter:"M-10244", patient:"Carlos Ruiz", state:"FL", type:"PT", provider:"Sunrise Rehab", requestedDate:"2026-01-08", sender:"Slack", status:"Sent to clinic", waiting:"Clinic", notes:"Confirm appointment date/time", due:"2026-01-08"},
    ],
    tasks: [
      {id:1, priority:"High", taskType:"Reply email", matter:"M-10255", desc:"Reply: DOB/DOA needed for referral", progress:"Open", due:"Today"},
      {id:2, priority:"High", taskType:"Reply email", matter:"M-10231", desc:"Send MRI order / required info", progress:"Open", due:"Today"},
      {id:3, priority:"Medium", taskType:"Follow-up clinic", matter:"M-10188", desc:"Follow-up on records (email)", progress:"Open", due:"Today"},
      {id:4, priority:"Medium", taskType:"Send referral", matter:"M-10244", desc:"Re-send referral + confirm receipt", progress:"Waiting", due:"Today"},
    ],
    providers: [
      {id:1, provider:"Peachtree Imaging", states:"GA", services:"MRI", email:"referrals@peachtreeimaging.com", method:"Email", notes:"Fast response if you include DOB/DOA + LOP."},
      {id:2, provider:"Sunrise Rehab", states:"FL", services:"Chiro/PT", email:"intake@sunriserehab.com", method:"Email", notes:"If no reply in 24h, call. Subject should include Matter #."},
      {id:3, provider:"Metro Pain", states:"GA, FL", services:"Pain Mgmt", email:"", method:"Portal", notes:"No direct email. Save confirmation in notes."},
    ],
    notesLog: [
      {dt:"2026-01-08 09:10", section:"Patients", ref:"M-10255", note:"Added patient from Slack."}
    ],
    reportMeta: {reported:false, reportedDate:""},
    reportLog: []
  };

  // =============================
  //  State init (auto-load)
  // =============================
  let priorityRows, emailActions, patients, tasks, providers, notesLog, reportMeta, reportLog;

  const saved = loadState();
  if(saved){
    priorityRows = saved.priorityRows || demo.priorityRows;
    emailActions  = saved.emailActions  || demo.emailActions;
    patients      = saved.patients      || demo.patients;
    tasks         = saved.tasks         || demo.tasks;
    providers     = saved.providers     || demo.providers;
    notesLog      = saved.notesLog      || demo.notesLog;
    reportMeta    = saved.reportMeta    || demo.reportMeta;
    reportLog     = saved.reportLog     || demo.reportLog;
  }else{
    ({priorityRows, emailActions, patients, tasks, providers, notesLog, reportMeta, reportLog} = demo);
  }

  // =============================
  //  Helpers
  // =============================
  function fillSelect(selectEl, options, includeBlank=false, blankLabel="(all)") {
    selectEl.innerHTML = "";
    if(includeBlank) {
      const o=document.createElement("option");
      o.value=""; o.textContent=blankLabel;
      selectEl.appendChild(o);
    }
    options.forEach(v=>{
      const o=document.createElement("option");
      o.value=v; o.textContent=v;
      selectEl.appendChild(o);
    });
  }

  function escapeHtml(s) {
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function mkSelectCell(value, options, onChangeJs) {
    const opts = options.map(o => `<option ${o===value?"selected":""}>${escapeHtml(o)}</option>`).join("");
    return `<select onchange="${onChangeJs}">${opts}</select>`;
  }

  function mailtoHref(email, subject="", body=""){
    const params = new URLSearchParams();
    if(subject) params.set("subject", subject);
    if(body) params.set("body", body);
    return `mailto:${encodeURIComponent(email)}?${params.toString()}`;
  }

  function addNote(section, ref, note){
    notesLog.unshift({dt: nowIso(), section, ref, note});
    saveState();
    renderNotesLog();
  }

  function findPatient(matter){
    if(!matter) return null;
    return patients.find(p=>String(p.matter).toLowerCase()===String(matter).toLowerCase()) || null;
  }

  function findProviderByName(name){
    if(!name) return null;
    return providers.find(p=>String(p.provider).toLowerCase()===String(name).toLowerCase()) || null;
  }

  // =============================
  //  HOME filtering (KPI click)
  // =============================
  let homeFilter = ""; // overdue | needs_reply | new_today | waiting_clinic

  function applyHomeFilter(kind){
    homeFilter = kind || "";
    const mapLabel = {
      "overdue":"Overdue today",
      "needs_reply":"Needs reply (reply today)",
      "new_today":"New today",
      "waiting_clinic":"Waiting on clinic",
      "":"All"
    };
    document.getElementById("homeFilterTag").textContent = mapLabel[homeFilter] || "All";
    renderHome();
  }

  function homeFilterRows(rows){
    if(!homeFilter) return rows;
    if(homeFilter==="needs_reply"){
      const matters = new Set(emailActions.filter(e=>String(e.type).toLowerCase()==="needs reply").map(e=>e.matter));
      return rows.filter(r=>matters.has(r.matter));
    }
    if(homeFilter==="waiting_clinic"){
      return rows.filter(r=>String(r.waiting).toLowerCase()==="clinic");
    }
    if(homeFilter==="new_today"){
      const d=new Date(); const pad=(n)=>String(n).padStart(2,"0");
      const today = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      const matters = new Set(patients.filter(p=>p.requestedDate===today).map(p=>p.matter));
      return rows.filter(r=>matters.has(r.matter));
    }
    if(homeFilter==="overdue"){
      return rows.filter(r=>String(r.due).toLowerCase()==="today" && ["stuck","pending records"].includes(String(r.status).toLowerCase()));
    }
    return rows;
  }

  // =============================
  //  Email Preview Modal
  // =============================
  const emailModal = document.getElementById("emailModalBackdrop");
  function openEmailModal(){ emailModal.classList.add("show"); }
  function closeEmailModal(){ emailModal.classList.remove("show"); }
  emailModal.addEventListener("click", (e)=>{ if(e.target===emailModal) closeEmailModal(); });

  function previewEmail(patient, provider, subject, body){
    const title = document.getElementById("emailModalTitle");
    const bodyEl = document.getElementById("emailModalBody");
    
    title.textContent = `‚úâÔ∏è Email to ${provider.provider}`;
    
    let html = `
      <div class="note"><b>To:</b> ${provider.email}</div>
      <div class="note"><b>Subject:</b> ${escapeHtml(subject)}</div>
      <div class="email-preview">${escapeHtml(body).replace(/\n/g, '<br>')}</div>
      <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap">
        <button class="btn" onclick="closeEmailModal()">‚úï Close</button>
        <a class="btn primary" href="${mailtoHref(provider.email, subject, body)}" target="_blank">üìß Open in Email Client</a>
        <button class="btn" onclick="copyToClipboard('${escapeHtml(body).replace(/'/g, "\\'")}')">üìã Copy Body</button>
      </div>
    `;
    
    bodyEl.innerHTML = html;
    openEmailModal();
  }

  function copyToClipboard(text){
    navigator.clipboard.writeText(text)
      .then(()=>alert("Copied to clipboard ‚úÖ"))
      .catch(()=>alert("Could not copy (browser permissions)."));
  }

  // =============================
  //  Build Email Template
  // =============================
  function buildProviderEmailTemplate(patient, provider){
    const clientName = patient ? patient.patient : "----";
    const matter = patient ? patient.matter : "----";
    const serviceType = patient ? patient.type : "----";
    
    const subject = `Client info ‚Äì ${clientName} (${matter}) ‚Äì ${serviceType}`;
    
    const body = [
      "Good afternoon.",
      "I hope this message finds you well.",
      `I'm reaching out to let you know that I'm sending the client's information for: ${clientName} (${matter}) - ${serviceType}.`,
      "",
      "- Is Transportation needed?:",
      "‚Ä¢ Name:",
      "‚Ä¢ Phone:",
      "‚Ä¢ Email:",
      "‚Ä¢ Address:",
      "‚Ä¢ DOA:",
      "‚Ä¢ DOB:",
      "‚Ä¢ Law Firm:",
      "‚Ä¢ Liability Limits and Status:",
      "",
      "If you have any specific requests or need additional details once you receive the information, feel free to let me know ‚Äî I'll be happy to assist.",
      "Thank you for your patience and cooperation.",
      "",
      "Best regards. üòä",
      "Isabel Galban",
      "Vital Marketing"
    ].join("\n");
    
    return {subject, body};
  }

  // =============================
  //  Render Functions
  // =============================
  function renderHome() {
    // KPIs
    const needsReplyCount = emailActions.filter(e=>String(e.type).toLowerCase()==="needs reply").length;
    document.getElementById("kpiNeedsReply").textContent = String(needsReplyCount);

    const waitingClinicCount = priorityRows.filter(r=>String(r.waiting).toLowerCase()==="clinic").length;
    document.getElementById("kpiWaiting").textContent = String(waitingClinicCount);

    const d=new Date(); const pad=(n)=>String(n).padStart(2,"0");
    const today = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const newTodayCount = patients.filter(p=>p.requestedDate===today).length;
    document.getElementById("kpiNew").textContent = String(newTodayCount);

    const overdueCount = priorityRows.filter(r=>String(r.due).toLowerCase()==="today" && ["stuck","pending records"].includes(String(r.status).toLowerCase())).length;
    document.getElementById("kpiOverdue").textContent = String(overdueCount);

    const shown = homeFilterRows(priorityRows);

    document.getElementById("tblPriority").innerHTML = shown.map((r, idx)=>`
      <tr>
        <td><a href="#" onclick="openPatient('${r.matter}')">${escapeHtml(r.matter)}</a></td>
        <td>${escapeHtml(r.patient)}</td>
        <td>${escapeHtml(r.state)}</td>
        <td><div class="cell">${mkSelectCell(r.type, TYPE_OPTIONS, `updatePriorityByMatter('${r.matter}','type',this.value)`)}</div></td>
        <td><div class="cell">${mkSelectCell(r.status, STATUS_OPTIONS, `updatePriorityByMatter('${r.matter}','status',this.value)`)}</div></td>
        <td><div class="cell">${mkSelectCell(r.waiting, WAITING_OPTIONS, `updatePriorityByMatter('${r.matter}','waiting',this.value)`)}</div></td>
        <td>${escapeHtml(r.next)}</td>
        <td>${escapeHtml(r.due)}</td>
        <td class="action-buttons">
          ${r.providerEmail ? `<button class="btn small" onclick="sendEmailFromPriority('${r.matter}')">üìß Email</button>` : ''}
          <button class="btn small" onclick="openPatient('${r.matter}')">üëÅÔ∏è View</button>
        </td>
      </tr>
    `).join("");

    document.getElementById("tblEmailActions").innerHTML = emailActions.map((e, idx)=>{
      const t = String(e.type).toLowerCase();
      const cls = (t==="needs reply") ? "orange" : (t==="follow-up" ? "gray" : "gray");
      const patient = findPatient(e.matter);
      const provider = providers.find(p=>p.email===e.providerEmail);
      const emailTemplate = buildProviderEmailTemplate(patient, provider || {provider: "Provider", email: e.providerEmail});
      
      return `
        <tr>
          <td><span class="badge ${cls}">${escapeHtml(e.type)}</span></td>
          <td>${escapeHtml(e.matter)}</td>
          <td>${escapeHtml(e.subject)}</td>
          <td>${escapeHtml(e.due)}</td>
          <td>${e.providerEmail ? `<a href="mailto:${e.providerEmail}">${escapeHtml(e.providerEmail)}</a>` : '<span class="badge gray">No email</span>'}</td>
          <td class="action-buttons">
            ${e.providerEmail ? `<button class="btn small" onclick="previewEmailFromAction(${idx})">üìß Preview</button>` : ''}
          </td>
        </tr>`;
    }).join("");
  }

  function renderPatients() {
    const q = (document.getElementById("patientSearch").value || "").toLowerCase();
    const fs = document.getElementById("filterStatus").value;
    const fw = document.getElementById("filterWaiting").value;

    const rows = patients.filter(p=>{
      const hay = `${p.matter} ${p.patient} ${p.state} ${p.type} ${p.provider} ${p.sender} ${p.status} ${p.waiting} ${p.notes}`.toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(fs && p.status !== fs) return false;
      if(fw && p.waiting !== fw) return false;
      return true;
    });

    document.getElementById("tblPatients").innerHTML = rows.map((p, idx)=>`
      <tr>
        <td><a href="#" onclick="openPatientDetail(${idx})">${escapeHtml(p.matter)}</a></td>
        <td>${escapeHtml(p.patient)}</td>
        <td>${escapeHtml(p.state)}</td>
        <td><div class="cell">${mkSelectCell(p.type, TYPE_OPTIONS, `updatePatientByMatter('${p.matter}','type',this.value)`)}</div></td>
        <td>${escapeHtml(p.provider)}</td>
        <td>${escapeHtml(p.requestedDate)}</td>
        <td>${escapeHtml(p.sender)}</td>
        <td><div class="cell">${mkSelectCell(p.status, STATUS_OPTIONS, `updatePatientByMatter('${p.matter}','status',this.value)`)}</div></td>
        <td><div class="cell">${mkSelectCell(p.waiting, WAITING_OPTIONS, `updatePatientByMatter('${p.matter}','waiting',this.value)`)}</div></td>
        <td>${escapeHtml(p.notes)}</td>
        <td>${escapeHtml(p.due)}</td>
        <td class="action-buttons">
          <button class="btn small" onclick="editPatient(${idx})">‚úèÔ∏è Edit</button>
          <button class="btn small danger" onclick="deletePatient(${idx})">üóëÔ∏è Delete</button>
        </td>
      </tr>
    `).join("");
  }

  function renderTasks() {
    const q = (document.getElementById("taskSearch").value || "").toLowerCase();
    const fs = document.getElementById("filterTaskStatus").value;
    const ft = document.getElementById("filterTaskType").value;

    const rows = tasks.filter(t=>{
      const hay = `${t.priority} ${t.taskType} ${t.matter} ${t.desc} ${t.progress} ${t.due}`.toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(fs && t.progress !== fs) return false;
      if(ft && t.taskType !== ft) return false;
      return true;
    });

    document.getElementById("tblTasks").innerHTML = rows.map((t, idx)=>`
      <tr>
        <td><span class="badge ${t.priority==='High'?'red':t.priority==='Medium'?'orange':'gray'}">${escapeHtml(t.priority)}</span></td>
        <td><div class="cell">${mkSelectCell(t.taskType, TASK_TYPE_OPTIONS, `updateTaskById(${t.id},'taskType',this.value)`)}</div></td>
        <td>${escapeHtml(t.matter)}</td>
        <td>${escapeHtml(t.desc)}</td>
        <td><div class="cell">${mkSelectCell(t.progress, TASK_PROGRESS_OPTIONS, `updateTaskById(${t.id},'progress',this.value); refreshPendingCount();`)}</div></td>
        <td>${escapeHtml(t.due)}</td>
        <td class="action-buttons">
          <button class="btn small" onclick="editTask(${idx})">‚úèÔ∏è Edit</button>
          <button class="btn small danger" onclick="deleteTask(${idx})">üóëÔ∏è Delete</button>
        </td>
      </tr>
    `).join("");
  }

  function renderProvidersTable(tbodyId){
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = providers.map((p, idx)=>`
      <tr>
        <td><b>${escapeHtml(p.provider)}</b></td>
        <td>${escapeHtml(p.states)}</td>
        <td><span class="badge gray">${escapeHtml(p.services)}</span></td>
        <td>${p.email ? `<a href="mailto:${p.email}">${escapeHtml(p.email)}</a>` : `<span class="badge gray">No email</span>`}</td>
        <td><span class="badge gray">${escapeHtml(p.method)}</span></td>
        <td>${escapeHtml(p.notes)}</td>
        <td class="action-buttons">
          ${p.email ? `<button class="btn small" onclick="sendEmailToProvider(${idx})">üìß Email</button>` : `<span class="badge gray">‚Äî</span>`}
          <button class="btn small" onclick="editProvider(${idx})">‚úèÔ∏è Edit</button>
          <button class="btn small danger" onclick="deleteProvider(${idx})">üóëÔ∏è Delete</button>
        </td>
      </tr>
    `).join("");
  }

  function renderProviders(){
    const q = (document.getElementById("providerSearch").value || "").toLowerCase();
    const fs = document.getElementById("filterService").value;
    const st = document.getElementById("filterProviderState").value;

    const filtered = providers.filter(p=>{
      const hay = `${p.provider} ${p.states} ${p.services} ${p.email} ${p.method} ${p.notes}`.toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(fs && p.services !== fs) return false;
      if(st && !String(p.states).split(",").map(x=>x.trim()).includes(st)) return false;
      return true;
    });

    document.getElementById("tblProviders").innerHTML = filtered.map((p, idx)=>`
      <tr>
        <td><b>${escapeHtml(p.provider)}</b></td>
        <td>${escapeHtml(p.states)}</td>
        <td><span class="badge gray">${escapeHtml(p.services)}</span></td>
        <td>${p.email ? `<a href="mailto:${p.email}">${escapeHtml(p.email)}</a>` : `<span class="badge gray">No email</span>`}</td>
        <td><span class="badge gray">${escapeHtml(p.method)}</span></td>
        <td>${escapeHtml(p.notes)}</td>
        <td class="action-buttons">
          ${p.email ? `<button class="btn small" onclick="sendEmailToProvider(${idx})">üìß Email</button>` : `<span class="badge gray">‚Äî</span>`}
          <button class="btn small" onclick="editProvider(${idx})">‚úèÔ∏è Edit</button>
          <button class="btn small danger" onclick="deleteProvider(${idx})">üóëÔ∏è Delete</button>
        </td>
      </tr>
    `).join("");
  }

  function renderNotesLog(){
    document.getElementById("tblNotesLog").innerHTML = notesLog.map(n=>`
      <tr>
        <td>${escapeHtml(n.dt)}</td>
        <td>${escapeHtml(n.section)}</td>
        <td>${escapeHtml(n.ref)}</td>
        <td>${escapeHtml(n.note)}</td>
      </tr>
    `).join("");
  }

  function renderReportLog(){
    document.getElementById("tblReportLog").innerHTML = reportLog.map((r, idx)=>`
      <tr>
        <td>${escapeHtml(r.savedAt)}</td>
        <td>${r.reported ? `<span class="badge green">Yes</span>` : `<span class="badge gray">No</span>`}</td>
        <td>${escapeHtml(r.reportedDate || "")}</td>
        <td>${escapeHtml(String(r.draft || "").slice(0,140))}${String(r.draft||"").length>140?"‚Ä¶":""}</td>
        <td class="action-buttons">
          <button class="btn small" onclick="editReportLog(${idx})">‚úèÔ∏è Edit</button>
          <button class="btn small danger" onclick="deleteReportLog(${idx})">üóëÔ∏è Delete</button>
        </td>
      </tr>
    `).join("");
  }

  function renderEmailPickers(){
    const pSel = document.getElementById("emailPatientPick");
    const prSel = document.getElementById("emailProviderPick");
    pSel.innerHTML = "";
    prSel.innerHTML = "";

    const p0 = document.createElement("option");
    p0.value=""; p0.textContent="Select patient‚Ä¶";
    pSel.appendChild(p0);

    patients.forEach(p=>{
      const o=document.createElement("option");
      o.value=p.matter;
      o.textContent = `${p.matter} ‚Äî ${p.patient}`;
      pSel.appendChild(o);
    });

    const pr0 = document.createElement("option");
    pr0.value=""; pr0.textContent="Select provider‚Ä¶";
    prSel.appendChild(pr0);

    providers.forEach(pr=>{
      const o=document.createElement("option");
      o.value=pr.provider;
      o.textContent = pr.provider + (pr.email ? ` (${pr.email})` : " (no email)");
      prSel.appendChild(o);
    });
  }

  // =============================
  //  CRUD Operations
  // =============================
  // Patients
  function editPatient(idx){
    const patient = patients[idx];
    openQuickLog();
    document.getElementById("quickLogTitle").textContent = "‚úèÔ∏è Edit Patient";
    document.getElementById("quickLogBody").innerHTML = renderPatientForm(patient, idx);
    initPatientForm();
  }

  function deletePatient(idx){
    if(confirm(`Delete patient ${patients[idx].patient} (${patients[idx].matter})?`)){
      const matter = patients[idx].matter;
      patients.splice(idx, 1);
      addNote("Patients", matter, "Deleted patient.");
      saveState();
      renderPatients();
      renderHome();
      renderEmailPickers();
    }
  }

  function openPatientDetail(idx){
    editPatient(idx);
  }

  // Tasks
  function editTask(idx){
    const task = tasks[idx];
    openQuickLog();
    document.getElementById("quickLogTitle").textContent = "‚úèÔ∏è Edit Task";
    document.getElementById("quickLogBody").innerHTML = renderTaskForm(task, idx);
    initTaskForm();
  }

  function deleteTask(idx){
    if(confirm(`Delete task "${tasks[idx].desc}"?`)){
      const matter = tasks[idx].matter;
      tasks.splice(idx, 1);
      addNote("Tasks", matter, "Deleted task.");
      saveState();
      renderTasks();
      refreshPendingCount();
    }
  }

  // Providers
  function editProvider(idx){
    const provider = providers[idx];
    openQuickLog();
    document.getElementById("quickLogTitle").textContent = "‚úèÔ∏è Edit Provider";
    document.getElementById("quickLogBody").innerHTML = renderProviderForm(provider, idx);
    initProviderForm();
  }

  function deleteProvider(idx){
    if(confirm(`Delete provider ${providers[idx].provider}?`)){
      const providerName = providers[idx].provider;
      providers.splice(idx, 1);
      addNote("Providers", providerName, "Deleted provider.");
      saveState();
      renderProviders();
      renderProvidersTable("tblProvidersInNotes");
      renderEmailPickers();
    }
  }

  // Report Log
  function editReportLog(idx){
    const report = reportLog[idx];
    if(prompt("Edit report preview (first 200 chars):", String(report.draft || "").substring(0,200))){
      report.draft = prompt("Enter new draft content:", report.draft || "");
      saveState();
      renderReportLog();
    }
  }

  function deleteReportLog(idx){
    if(confirm("Delete this report log entry?")){
      reportLog.splice(idx, 1);
      saveState();
      renderReportLog();
    }
  }

  // =============================
  //  Updates (by Matter / id)
  // =============================
  function updatePriorityByMatter(matter, field, value){
    const i = priorityRows.findIndex(r=>r.matter===matter);
    if(i>=0){ priorityRows[i][field]=value; saveState(); renderHome(); }
  }
  
  function updatePatientByMatter(matter, field, value){
    const i = patients.findIndex(p=>p.matter===matter);
    if(i>=0){ 
      patients[i][field]=value; 
      addNote("Patients", matter, `Updated ${field} ‚Üí ${value}`); 
      saveState(); 
      renderPatients(); 
      renderHome(); 
      renderEmailPickers(); 
    }
  }
  
  function updateTaskById(id, field, value){
    const i = tasks.findIndex(t=>t.id===id);
    if(i>=0){ 
      tasks[i][field]=value; 
      addNote("Tasks", tasks[i].matter, `Updated ${field} ‚Üí ${value}`); 
      saveState(); 
      renderTasks(); 
    }
  }

  // =============================
  //  Email Functions
  // =============================
  function sendEmailFromPriority(matter){
    const patient = findPatient(matter);
    const priorityRow = priorityRows.find(r=>r.matter===matter);
    if(!priorityRow || !priorityRow.providerEmail){
      alert("No provider email found for this matter.");
      return;
    }
    
    const provider = providers.find(p=>p.email===priorityRow.providerEmail) || {provider: "Provider", email: priorityRow.providerEmail};
    const emailTemplate = buildProviderEmailTemplate(patient, provider);
    previewEmail(patient, provider, emailTemplate.subject, emailTemplate.body);
  }

  function previewEmailFromAction(idx){
    const e = emailActions[idx];
    const patient = findPatient(e.matter);
    const provider = providers.find(p=>p.email===e.providerEmail) || {provider: "Provider", email: e.providerEmail};
    const emailTemplate = buildProviderEmailTemplate(patient, provider);
    previewEmail(patient, provider, emailTemplate.subject, emailTemplate.body);
  }

  function sendEmailToProvider(idx){
    const provider = providers[idx];
    if(!provider.email){
      alert("This provider has no email saved.");
      return;
    }
    
    const emailTemplate = buildProviderEmailTemplate(null, provider);
    previewEmail(null, provider, emailTemplate.subject, emailTemplate.body);
  }

  // =============================
  //  Navigation
  // =============================
  const pages=["home","patients","tasks","notes","providers","reports"];
  const titles={
    home:["Home","Quick view of what matters today"],
    patients:["Patients","Your operational list"],
    tasks:["Tasks","Emails ‚Üí actions"],
    notes:["Notes","Logs + email drafts"],
    providers:["Providers","Operational directory"],
    reports:["Reports","4pm report"]
  };

  function setQuickLogVisibility(){
    const page = getActivePage();
    const show = ["patients","tasks","notes","providers"].includes(page);
    document.getElementById("btnQuickLog").style.display = show ? "inline-flex" : "none";
  }

  document.querySelectorAll(".nav button").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const target=btn.dataset.page;
      pages.forEach(p=>document.getElementById("page-"+p).classList.toggle("active", p===target));
      document.getElementById("pageTitle").textContent=titles[target][0];
      document.getElementById("pageSubtitle").textContent=titles[target][1];
      setQuickLogVisibility();
    });
  });

  // =============================
  //  Filters
  // =============================
  ["patientSearch","filterStatus","filterWaiting"].forEach(id=>{
    document.getElementById(id).addEventListener("input", renderPatients);
    document.getElementById(id).addEventListener("change", renderPatients);
  });
  document.getElementById("btnClearPatients").addEventListener("click", ()=>{
    patientSearch.value=""; filterStatus.value=""; filterWaiting.value=""; renderPatients();
  });

  ["taskSearch","filterTaskStatus","filterTaskType"].forEach(id=>{
    document.getElementById(id).addEventListener("input", renderTasks);
    document.getElementById(id).addEventListener("change", renderTasks);
  });
  document.getElementById("btnClearTasks").addEventListener("click", ()=>{
    taskSearch.value=""; filterTaskStatus.value=""; filterTaskType.value=""; renderTasks();
  });

  ["providerSearch","filterService","filterProviderState"].forEach(id=>{
    document.getElementById(id).addEventListener("input", renderProviders);
    document.getElementById(id).addEventListener("change", renderProviders);
  });
  document.getElementById("btnClearProviders").addEventListener("click", ()=>{
    providerSearch.value=""; filterService.value=""; filterProviderState.value=""; renderProviders();
  });

  // Email matter search
  document.getElementById("emailMatterSearch").addEventListener("input", function(){
    const search = this.value.toLowerCase();
    const select = document.getElementById("emailPatientPick");
    
    for(let i=0; i<select.options.length; i++){
      const option = select.options[i];
      option.style.display = option.value.toLowerCase().includes(search) || option.text.toLowerCase().includes(search) ? "" : "none";
    }
  });

  // =============================
  //  Assistant chat (improved)
  // =============================
  function appendBubble(text, who){
    const chat=document.getElementById("chat");
    const d=document.createElement("div");
    d.className="bubble "+(who==="me"?"me":"bot");
    d.innerHTML=text; chat.appendChild(d); chat.scrollTop=chat.scrollHeight;
  }
  
  function botReply(msg){
    const m=msg.toLowerCase().trim();

    // Send email command
    if(m.includes("send email") || m.includes("email for")){
      const match = m.match(/(m-?\d+)/i);
      if(match){
        const matter = match[1].toUpperCase();
        const patient = findPatient(matter);
        if(patient){
          const priorityRow = priorityRows.find(r=>r.matter===matter);
          if(priorityRow && priorityRow.providerEmail){
            const provider = providers.find(p=>p.email===priorityRow.providerEmail) || {provider: "Provider", email: priorityRow.providerEmail};
            const emailTemplate = buildProviderEmailTemplate(patient, provider);
            previewEmail(patient, provider, emailTemplate.subject, emailTemplate.body);
            return `Opening email preview for <b>${escapeHtml(matter)}</b> to ${escapeHtml(provider.provider)}.`;
          }else{
            return `No provider email found for <b>${escapeHtml(matter)}</b>. Add it in Providers section.`;
          }
        }else{
          return `Patient <b>${escapeHtml(matter)}</b> not found.`;
        }
      }
      return "Please specify a Matter #, like: 'send email for M-10231'";
    }

    // Update status command
    if(m.includes("update") && m.includes("status") && m.includes("to")){
      const matterMatch = m.match(/(m-?\d+)/i);
      const statusMatch = m.match(/to\s+(\w+)/i);
      
      if(matterMatch && statusMatch){
        const matter = matterMatch[1].toUpperCase();
        const newStatus = statusMatch[1].charAt(0).toUpperCase() + statusMatch[1].slice(1).toLowerCase();
        
        if(STATUS_OPTIONS.includes(newStatus)){
          const i = patients.findIndex(p=>p.matter===matter);
          if(i>=0){
            patients[i].status = newStatus;
            addNote("Patients", matter, `Assistant updated status ‚Üí ${newStatus}`);
            saveState();
            renderPatients();
            renderHome();
            return `Updated <b>${escapeHtml(matter)}</b> status to <b>${escapeHtml(newStatus)}</b>.`;
          }else{
            return `Patient <b>${escapeHtml(matter)}</b> not found.`;
          }
        }else{
          return `Status "${escapeHtml(newStatus)}" not valid. Valid: ${STATUS_OPTIONS.join(", ")}`;
        }
      }
      return "Format: 'update M-10231 status to Scheduled'";
    }

    if(m.includes("show needs reply") || m==="needs reply"){
      applyHomeFilter("needs_reply");
      return "Filtered ‚úÖ (Home ‚Üí Priority). Click any Matter to open it in Patients.";
    }
    
    if(m.includes("waiting on clinic")){
      applyHomeFilter("waiting_clinic");
      return "Filtered ‚úÖ (Waiting on clinic).";
    }
    
    if(m.startsWith("open ")){
      const matter = msg.slice(5).trim();
      openPatient(matter);
      return `Opened <b>${escapeHtml(matter)}</b> in Patients.`;
    }
    
    if(m.includes("pending")){
      const pending = tasks.filter(t=>!["Done","Updated"].includes(t.progress)).length;
      return `You have <b>${pending}</b> pending tasks. Want to filter by <b>Reply email</b> or <b>Follow-up clinic</b>?`;
    }
    
    return "I can: <b>send email for M-XXXX</b>, <b>update M-XXXX status to ...</b>, <b>show needs reply</b>, <b>waiting on clinic</b>, or <b>open M-XXXX</b>.";
  }
  
  document.getElementById("send").addEventListener("click", ()=>{
    const input=document.getElementById("msg");
    const msg=input.value.trim(); if(!msg) return;
    appendBubble(escapeHtml(msg),"me"); input.value="";
    setTimeout(()=>appendBubble(botReply(msg),"bot"),150);
  });
  
  document.getElementById("msg").addEventListener("keydown",(e)=>{ if(e.key==="Enter") document.getElementById("send").click(); });

  // =============================
  //  Collapse assistant
  // =============================
  function toggleAssistant(){ document.body.classList.toggle("assistant-collapsed"); }
  document.getElementById("btnCollapseAssistant").addEventListener("click", toggleAssistant);
  document.getElementById("btnToggleAssistant").addEventListener("click", toggleAssistant);

  // =============================
  //  Quick Log modal (dynamic by page)
  // =============================
  const backdrop = document.getElementById("modalBackdrop");
  function openModal(){ backdrop.classList.add("show"); }
  function closeModal(){ backdrop.classList.remove("show"); }
  window.closeModal = closeModal;
  backdrop.addEventListener("click", (e)=>{ if(e.target===backdrop) closeModal(); });

  function getActivePage(){
    return pages.find(p => document.getElementById("page-"+p).classList.contains("active")) || "home";
  }

  function openQuickLog(){
    const page = getActivePage();
    const title = document.getElementById("quickLogTitle");
    const body = document.getElementById("quickLogBody");

    if(page==="patients"){
      title.textContent = "‚ûï Quick Log (Add Patient)";
      body.innerHTML = renderPatientForm();
      initPatientForm();
      openModal();
      return;
    }
    if(page==="tasks"){
      title.textContent = "‚ûï Quick Log (Add Task)";
      body.innerHTML = renderTaskForm();
      initTaskForm();
      openModal();
      return;
    }
    if(page==="notes" || page==="providers"){
      title.textContent = "‚ûï Quick Log (Add Provider)";
      body.innerHTML = renderProviderForm();
      initProviderForm();
      openModal();
      return;
    }
  }
  document.getElementById("btnQuickLog").addEventListener("click", openQuickLog);

  // Initialize Quick Log forms
  function initPatientForm(){
    const elType=document.getElementById("fType");
    const elStatus=document.getElementById("fStatus");
    const elWaiting=document.getElementById("fWaiting");
    if(elType) fillSelect(elType, TYPE_OPTIONS, false);
    if(elStatus) fillSelect(elStatus, STATUS_OPTIONS, false);
    if(elWaiting) fillSelect(elWaiting, WAITING_OPTIONS, false);
  }
  
  function initTaskForm(){
    const elType=document.getElementById("tType");
    const elProg=document.getElementById("tProgress");
    if(elType) fillSelect(elType, TASK_TYPE_OPTIONS, false);
    if(elProg) fillSelect(elProg, TASK_PROGRESS_OPTIONS, false);
    const d=new Date(); const pad=(n)=>String(n).padStart(2,"0");
    const due=document.getElementById("tDue");
    if(due) due.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  
  function initProviderForm(){
    const el=document.getElementById("pService");
    if(el) fillSelect(el, SERVICE_OPTIONS, false);
  }

  // Form renderers
  function renderPatientForm(patient=null, idx=null){
    const d=new Date(); const pad=(n)=>String(n).padStart(2,"0");
    const today = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    
    const isEdit = patient !== null;
    const action = isEdit ? `savePatientEdit(${idx})` : "savePatientQuickLog()";
    const buttonText = isEdit ? "Update" : "Save";
    
    return `
      <div class="formgrid">
        <div class="col4">
          <label class="note">Matter</label>
          <input class="input" id="fMatter" placeholder="e.g., 111002 or M-10255" value="${patient ? escapeHtml(patient.matter) : ''}"/>
        </div>
        <div class="col4">
          <label class="note">Patient</label>
          <input class="input" id="fPatient" placeholder="Full name" value="${patient ? escapeHtml(patient.patient) : ''}"/>
        </div>
        <div class="col4">
          <label class="note">State</label>
          <input class="input" id="fState" placeholder="e.g., GA" value="${patient ? escapeHtml(patient.state) : ''}"/>
        </div>

        <div class="col4">
          <label class="note">Type</label>
          <select id="fType">${TYPE_OPTIONS.map(o=>`<option ${patient && patient.type===o?'selected':''}>${o}</option>`).join('')}</select>
        </div>
        <div class="col4">
          <label class="note">Provider</label>
          <input class="input" id="fProvider" placeholder="Provider name" value="${patient ? escapeHtml(patient.provider) : ''}"/>
        </div>
        <div class="col4">
          <label class="note">Requested Date</label>
          <input class="input" id="fRequested" type="date" value="${patient ? patient.requestedDate : today}"/>
        </div>

        <div class="col4">
          <label class="note">Sender</label>
          <input class="input" id="fSender" placeholder="Slack/Email/name" value="${patient ? escapeHtml(patient.sender) : ''}"/>
        </div>
        <div class="col4">
          <label class="note">Status</label>
          <select id="fStatus">${STATUS_OPTIONS.map(o=>`<option ${patient && patient.status===o?'selected':''}>${o}</option>`).join('')}</select>
        </div>
        <div class="col4">
          <label class="note">Waiting On</label>
          <select id="fWaiting">${WAITING_OPTIONS.map(o=>`<option ${patient && patient.waiting===o?'selected':''}>${o}</option>`).join('')}</select>
        </div>

        <div class="col12">
          <label class="note">Notes</label>
          <textarea id="fNotes" placeholder="Anything you need to remember‚Ä¶">${patient ? escapeHtml(patient.notes) : ''}</textarea>
          <div class="helper">Tip: put missing items here (DOB/DOA, MRI order, records, etc.).</div>
        </div>

        <div class="col4">
          <label class="note">Due Date</label>
          <input class="input" id="fDue" type="date" value="${patient ? patient.due : today}"/>
        </div>
        <div class="col8" style="display:flex;align-items:flex-end;gap:10px;justify-content:flex-end">
          <button class="btn" onclick="closeModal()">Cancel</button>
          ${isEdit ? `<button class="btn danger" onclick="deletePatient(${idx})">üóëÔ∏è Delete</button>` : ''}
          <button class="btn primary" onclick="${action}">${buttonText}</button>
        </div>
      </div>
    `;
  }

  function savePatientQuickLog(){
    const p = {
      matter: document.getElementById("fMatter").value.trim() || "(missing)",
      patient: document.getElementById("fPatient").value.trim() || "(missing)",
      state: document.getElementById("fState").value.trim() || "",
      type: document.getElementById("fType").value,
      provider: document.getElementById("fProvider").value.trim() || "",
      requestedDate: document.getElementById("fRequested").value || "",
      sender: document.getElementById("fSender").value.trim() || "",
      status: document.getElementById("fStatus").value,
      waiting: document.getElementById("fWaiting").value,
      notes: document.getElementById("fNotes").value.trim() || "",
      due: document.getElementById("fDue").value || "",
    };
    patients.unshift(p);
    addNote("Patients", p.matter, "Added patient.");
    saveState();
    closeModal();
    document.querySelector('.nav button[data-page="patients"]').click();
    renderPatients(); renderHome(); renderEmailPickers();
  }
  window.savePatientQuickLog = savePatientQuickLog;

  function savePatientEdit(idx){
    const p = {
      matter: document.getElementById("fMatter").value.trim() || "(missing)",
      patient: document.getElementById("fPatient").value.trim() || "(missing)",
      state: document.getElementById("fState").value.trim() || "",
      type: document.getElementById("fType").value,
      provider: document.getElementById("fProvider").value.trim() || "",
      requestedDate: document.getElementById("fRequested").value || "",
      sender: document.getElementById("fSender").value.trim() || "",
      status: document.getElementById("fStatus").value,
      waiting: document.getElementById("fWaiting").value,
      notes: document.getElementById("fNotes").value.trim() || "",
      due: document.getElementById("fDue").value || "",
    };
    patients[idx] = p;
    addNote("Patients", p.matter, "Updated patient.");
    saveState();
    closeModal();
    renderPatients(); renderHome(); renderEmailPickers();
  }
  window.savePatientEdit = savePatientEdit;

  function renderTaskForm(task=null, idx=null){
    const isEdit = task !== null;
    const action = isEdit ? `saveTaskEdit(${idx})` : "saveTaskQuickLog()";
    const buttonText = isEdit ? "Update" : "Save";
    
    return `
      <div class="formgrid">
        <div class="col3">
          <label class="note">Priority</label>
          <select id="tPriority">
            <option ${task && task.priority==='High'?'selected':''}>High</option>
            <option ${task && task.priority==='Medium'?'selected':!task?'selected':''}>Medium</option>
            <option ${task && task.priority==='Low'?'selected':''}>Low</option>
          </select>
        </div>
        <div class="col3">
          <label class="note">Task Type</label>
          <select id="tType">${TASK_TYPE_OPTIONS.map(o=>`<option ${task && task.taskType===o?'selected':''}>${o}</option>`).join('')}</select>
        </div>
        <div class="col3">
          <label class="note">Progress</label>
          <select id="tProgress">${TASK_PROGRESS_OPTIONS.map(o=>`<option ${task && task.progress===o?'selected':''}>${o}</option>`).join('')}</select>
        </div>
        <div class="col3">
          <label class="note">Due</label>
          <input class="input" id="tDue" type="date" value="${task ? task.due : ''}"/>
        </div>

        <div class="col4">
          <label class="note">Matter</label>
          <input class="input" id="tMatter" placeholder="e.g., M-10231" value="${task ? escapeHtml(task.matter) : ''}"/>
        </div>
        <div class="col8">
          <label class="note">Description</label>
          <input class="input" id="tDesc" placeholder="What needs to happen?" value="${task ? escapeHtml(task.desc) : ''}"/>
        </div>

        <div class="col12" style="display:flex;align-items:flex-end;gap:10px;justify-content:flex-end">
          <button class="btn" onclick="closeModal()">Cancel</button>
          ${isEdit ? `<button class="btn danger" onclick="deleteTask(${idx})">üóëÔ∏è Delete</button>` : ''}
          <button class="btn primary" onclick="${action}">${buttonText}</button>
        </div>
      </div>
    `;
  }

  function saveTaskQuickLog(){
    const maxId = tasks.length > 0 ? Math.max(...tasks.map(t=>t.id || 0)) : 0;
    const t = {
      id: maxId + 1,
      priority: document.getElementById("tPriority").value,
      taskType: document.getElementById("tType").value,
      matter: document.getElementById("tMatter").value.trim() || "(missing)",
      desc: document.getElementById("tDesc").value.trim() || "(missing)",
      progress: document.getElementById("tProgress").value,
      due: document.getElementById("tDue").value || ""
    };
    tasks.unshift(t);
    addNote("Tasks", t.matter, `Added task: ${t.taskType}.`);
    saveState();
    closeModal();
    document.querySelector('.nav button[data-page="tasks"]').click();
    renderTasks(); refreshPendingCount();
  }
  window.saveTaskQuickLog = saveTaskQuickLog;

  function saveTaskEdit(idx){
    const t = {
      id: tasks[idx].id,
      priority: document.getElementById("tPriority").value,
      taskType: document.getElementById("tType").value,
      matter: document.getElementById("tMatter").value.trim() || "(missing)",
      desc: document.getElementById("tDesc").value.trim() || "(missing)",
      progress: document.getElementById("tProgress").value,
      due: document.getElementById("tDue").value || ""
    };
    tasks[idx] = t;
    addNote("Tasks", t.matter, `Updated task: ${t.taskType}.`);
    saveState();
    closeModal();
    renderTasks(); refreshPendingCount();
  }
  window.saveTaskEdit = saveTaskEdit;

  function renderProviderForm(provider=null, idx=null){
    const isEdit = provider !== null;
    const action = isEdit ? `saveProviderEdit(${idx})` : "saveProviderQuickLog()";
    const buttonText = isEdit ? "Update" : "Save";
    
    return `
      <div class="formgrid">
        <div class="col6">
          <label class="note">Provider Name</label>
          <input class="input" id="pName" placeholder="Provider / Clinic name" value="${provider ? escapeHtml(provider.provider) : ''}"/>
        </div>
        <div class="col3">
          <label class="note">Service</label>
          <select id="pService">${SERVICE_OPTIONS.map(o=>`<option ${provider && provider.services===o?'selected':''}>${o}</option>`).join('')}</select>
        </div>
        <div class="col3">
          <label class="note">States</label>
          <input class="input" id="pStates" placeholder="e.g., GA, FL" value="${provider ? escapeHtml(provider.states) : ''}"/>
        </div>

        <div class="col6">
          <label class="note">Email</label>
          <input class="input" id="pEmail" placeholder="referrals@clinic.com" value="${provider ? escapeHtml(provider.email) : ''}"/>
        </div>
        <div class="col3">
          <label class="note">Method</label>
          <select id="pMethod">
            <option ${provider && provider.method==='Email'?'selected':''}>Email</option>
            <option ${provider && provider.method==='Portal'?'selected':''}>Portal</option>
            <option ${provider && provider.method==='Phone'?'selected':''}>Phone</option>
            <option ${provider && provider.method==='Fax'?'selected':''}>Fax</option>
          </select>
        </div>
        <div class="col3">
          <label class="note">Phone (optional)</label>
          <input class="input" id="pPhone" placeholder="(optional)" value="${provider ? escapeHtml(provider.phone || '') : ''}"/>
        </div>

        <div class="col12">
          <label class="note">Notes</label>
          <textarea id="pNotes" placeholder="Any operational notes‚Ä¶">${provider ? escapeHtml(provider.notes) : ''}</textarea>
        </div>

        <div class="col12" style="display:flex;align-items:flex-end;gap:10px;justify-content:flex-end">
          <button class="btn" onclick="closeModal()">Cancel</button>
          ${isEdit ? `<button class="btn danger" onclick="deleteProvider(${idx})">üóëÔ∏è Delete</button>` : ''}
          <button class="btn primary" onclick="${action}">${buttonText}</button>
        </div>
      </div>
    `;
  }

  function saveProviderQuickLog(){
    const maxId = providers.length > 0 ? Math.max(...providers.map(p=>p.id || 0)) : 0;
    const p = {
      id: maxId + 1,
      provider: document.getElementById("pName").value.trim() || "(missing)",
      states: document.getElementById("pStates").value.trim() || "",
      services: document.getElementById("pService").value,
      email: document.getElementById("pEmail").value.trim() || "",
      method: document.getElementById("pMethod").value,
      phone: document.getElementById("pPhone").value.trim() || "",
      notes: document.getElementById("pNotes").value.trim() || ""
    };
    providers.unshift(p);
    addNote("Providers", p.provider, "Added provider.");
    saveState();
    closeModal();
    renderProviders(); renderProvidersTable("tblProvidersInNotes"); renderEmailPickers();
  }
  window.saveProviderQuickLog = saveProviderQuickLog;

  function saveProviderEdit(idx){
    const p = {
      id: providers[idx].id,
      provider: document.getElementById("pName").value.trim() || "(missing)",
      states: document.getElementById("pStates").value.trim() || "",
      services: document.getElementById("pService").value,
      email: document.getElementById("pEmail").value.trim() || "",
      method: document.getElementById("pMethod").value,
      phone: document.getElementById("pPhone").value.trim() || "",
      notes: document.getElementById("pNotes").value.trim() || ""
    };
    providers[idx] = p;
    addNote("Providers", p.provider, "Updated provider.");
    saveState();
    closeModal();
    renderProviders(); renderProvidersTable("tblProvidersInNotes"); renderEmailPickers();
  }
  window.saveProviderEdit = saveProviderEdit;

  // =============================
  //  Quick buttons (tasks)
  // =============================
  function quickTask(taskType, desc){
    const maxId = tasks.length > 0 ? Math.max(...tasks.map(t=>t.id || 0)) : 0;
    tasks.unshift({
      id: maxId + 1,
      priority:"Medium", 
      taskType, 
      matter:"(set)", 
      desc, 
      progress:"Open", 
      due:"Today"
    });
    addNote("Tasks", "(set)", `Quick button: ${taskType}.`);
    saveState();
    renderTasks();
    appendBubble(`Created a task: <b>${escapeHtml(taskType)}</b> ‚Äî ${escapeHtml(desc)}. Edit the Matter in the table or use Quick Log to add a clean task.`,"bot");
    refreshPendingCount();
  }
  window.quickTask = quickTask;

  // =============================
  //  Report Functions
  // =============================
  function regenerateReport(){
    const lines=[
      "Daily Report ‚Äì Medical Dept",
      "",
      `Patients in system: ${patients.length}`,
      `Open tasks: ${tasks.filter(t=>!["Done","Updated"].includes(t.progress)).length}`,
      "",
      "Key pending / issues:",
      ...tasks.filter(t=>!["Done","Updated"].includes(t.progress)).slice(0,6).map(t=>`- ${t.matter}: ${t.taskType} ‚Äî ${t.desc}`)
    ];
    document.getElementById("reportDraft").textContent=lines.join("\n");
  }
  
  function copyReport(){
    navigator.clipboard.writeText(document.getElementById("reportDraft").textContent)
      .then(()=>alert("Copied ‚úÖ")).catch(()=>alert("Could not copy (browser permissions)."));
  }
  window.copyReport = copyReport;
  window.regenerateReport = regenerateReport;

  function saveReportMeta(){
    const chk = document.getElementById("reportedChk").checked;
    const dt = document.getElementById("reportedDate").value;
    reportMeta = {reported: chk, reportedDate: dt || ""};

    // log record
    const record = {
      savedAt: nowIso(),
      reported: chk,
      reportedDate: dt || "",
      draft: document.getElementById("reportDraft").textContent || ""
    };
    reportLog.unshift(record);

    document.getElementById("reportMetaNote").textContent = chk ? `Reported ‚úÖ  ${dt || "(date not set)"}` : "Not marked as reported.";
    addNote("Reports", "4pm", chk ? `Saved report meta (Reported ‚úÖ).` : "Saved report meta.");
    saveState();
    renderReportLog();
  }
  window.saveReportMeta = saveReportMeta;
  document.getElementById("btnSaveReportMeta").addEventListener("click", saveReportMeta);

  document.getElementById("btnGenerateReport").addEventListener("click", ()=>{
    regenerateReport();
    document.querySelector('.nav button[data-page="reports"]').click();
  });

  // =============================
  //  Email draft from Notes
  // =============================
  function openEmailDraft(){
    const matter = document.getElementById("emailPatientPick").value;
    const providerName = document.getElementById("emailProviderPick").value;
    if(!matter || !providerName) return alert("Select patient + provider first.");
    const patient = findPatient(matter);
    const provider = findProviderByName(providerName);
    if(!provider || !provider.email) return alert("That provider has no email saved yet.");
    const emailTemplate = buildProviderEmailTemplate(patient, provider);
    previewEmail(patient, provider, emailTemplate.subject, emailTemplate.body);
  }
  document.getElementById("btnOpenEmailDraft").addEventListener("click", openEmailDraft);

  // =============================
  //  Open patient helper
  // =============================
  function openPatient(matter){
    document.querySelector('.nav button[data-page="patients"]').click();
    patientSearch.value = matter;
    renderPatients();
  }
  window.openPatient = openPatient;

  function refreshPendingCount(){
    const pending = tasks.filter(t=>!["Done","Updated"].includes(t.progress)).length;
    document.getElementById("pendingCount").textContent = String(pending);
  }

  // =============================
  //  Excel download (HTML-as-XLS)
  // =============================
  function tableToXlsHtml(tableEl, sheetName="Sheet1"){
    const html = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
      <head>
        <!--[if gte mso 9]><xml>
          <x:ExcelWorkbook>
            <x:ExcelWorksheets>
              <x:ExcelWorksheet>
                <x:Name>${sheetName}</x:Name>
                <x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions>
              </x:ExcelWorksheet>
            </x:ExcelWorksheets>
          </x:ExcelWorkbook>
        </xml><![endif]-->
        <meta charset="utf-8"/>
      </head>
      <body>${tableEl.outerHTML}</body></html>`;
    return html;
  }

  function downloadXls(filename, tableEl, sheetName){
    const content = tableToXlsHtml(tableEl, sheetName);
    const blob = new Blob([content], {type: "application/vnd.ms-excel"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function downloadCurrentPageExcel(){
    const page = getActivePage();
    const firstTable = document.querySelector(`#page-${page} table.table`);
    if(page==="reports"){
      const t = document.getElementById("reportDraft").textContent;
      const temp = document.createElement("table");
      temp.innerHTML = `<tr><th>Report</th></tr><tr><td style="white-space:pre-wrap">${escapeHtml(t).replaceAll("\n","<br/>")}</td></tr>`;
      return downloadXls("CommandCenter_REPORT.xls", temp, "Report");
    }
    if(!firstTable) return alert("No table found on this page.");
    return downloadXls(`CommandCenter_${page.toUpperCase()}.xls`, firstTable, page);
  }
  window.downloadCurrentPageExcel = downloadCurrentPageExcel;
  document.getElementById("btnDownloadExcel").addEventListener("click", downloadCurrentPageExcel);

  // =============================
  //  Home KPI click wiring
  // =============================
  document.querySelectorAll("[data-homefilter]").forEach(el=>{
    el.addEventListener("click", ()=>applyHomeFilter(el.dataset.homefilter));
  });
  document.getElementById("btnClearHomeFilter").addEventListener("click", ()=>applyHomeFilter(""));

  // =============================
  //  Init
  // =============================
  fillSelect(document.getElementById("filterStatus"), STATUS_OPTIONS, true, "Status (all)");
  fillSelect(document.getElementById("filterWaiting"), WAITING_OPTIONS, true, "Waiting On (all)");
  fillSelect(document.getElementById("filterTaskStatus"), TASK_PROGRESS_OPTIONS, true, "Progress (all)");
  fillSelect(document.getElementById("filterTaskType"), TASK_TYPE_OPTIONS, true, "Task Type (all)");
  fillSelect(document.getElementById("filterService"), SERVICE_OPTIONS, true, "Service (all)");
  fillSelect(document.getElementById("filterProviderState"), ["GA","FL","TX","CA","NY"], true, "State (all)");

  document.getElementById("reportedChk").checked = !!reportMeta.reported;
  document.getElementById("reportedDate").value = reportMeta.reportedDate || "";

  renderHome();
  renderPatients();
  renderTasks();
  renderProviders();
  renderProvidersTable("tblProvidersInNotes");
  renderNotesLog();
  renderReportLog();
  renderEmailPickers();
  regenerateReport();
  refreshPendingCount();
  setQuickLogVisibility();
  saveState();
</script>

</body>
</html>
